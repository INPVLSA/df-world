{% extends "base.html" %}

{% block title %}Dashboard - DF-World{% endblock %}

{% block content %}
<h1>Dashboard</h1>

{% if world %}
<div class="world-info">
    <h2>{{ world.name }}</h2>
    {% if world.altname %}<p class="altname">{{ world.altname }}</p>{% endif %}

    {% if current_world %}
    <p class="world-status">
        {% if current_world.has_plus %}
        <span class="status-badge status-plus">DFHack Extended</span>
        {% else %}
        <span class="status-badge status-basic">Basic Import</span>
        {% endif %}
    </p>
    {% endif %}

    {% if all_worlds|length > 1 %}
    <div class="world-switcher">
        <label for="world-select">Switch world:</label>
        <select id="world-select" onchange="switchWorld(this.value)">
            {% for w in all_worlds %}
            <option value="{{ w.id }}" {% if current_world and w.id == current_world.id %}selected{% endif %}>
                {{ w.name }}{% if w.altname %} ({{ w.altname }}){% endif %}{% if w.has_plus %} [+]{% endif %}
            </option>
            {% endfor %}
        </select>
        {% if current_world %}
        <button type="button" class="btn btn-delete" onclick="deleteWorld('{{ current_world.id }}', '{{ current_world.name }}')" title="Delete this world">X</button>
        {% endif %}
    </div>
    {% elif current_world %}
    <div class="world-switcher">
        <button type="button" class="btn btn-delete" onclick="deleteWorld('{{ current_world.id }}', '{{ current_world.name }}')" title="Delete this world">Delete World</button>
    </div>
    {% endif %}

    {% if current_world and not current_world.has_plus %}
    <div class="merge-section">
        <p class="hint">This world was imported without DFHack data. You can add extended data now:</p>
        <form method="post" action="{{ url_for('merge_plus', world_id=current_world.id) }}" enctype="multipart/form-data" id="merge-form">
            <div class="merge-area">
                <label class="upload-label merge-label">
                    <span class="upload-name" id="merge-plus-name">Select legends_plus.xml</span>
                    <input type="file" name="legends_plus" accept=".xml" id="merge-plus-input">
                </label>
                <button type="submit" class="btn" id="merge-btn" disabled>Merge DFHack Data</button>
            </div>
        </form>
    </div>
    {% endif %}
</div>
{% else %}
<div class="world-info empty">
    <h2>No World Loaded</h2>
    <p>Import your Dwarf Fortress legends data to get started.</p>
</div>
{% endif %}

<script>
function switchWorld(worldId) {
    if (worldId) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/switch-world/' + worldId;
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteWorld(worldId, worldName) {
    if (confirm('Are you sure you want to delete "' + worldName + '"? This cannot be undone.')) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/delete-world/' + worldId;
        document.body.appendChild(form);
        form.submit();
    }
}

// Merge form handling
(function() {
    var mergeInput = document.getElementById('merge-plus-input');
    var mergeName = document.getElementById('merge-plus-name');
    var mergeBtn = document.getElementById('merge-btn');
    var mergeForm = document.getElementById('merge-form');

    if (mergeInput && mergeName && mergeBtn) {
        mergeInput.addEventListener('change', function() {
            if (mergeInput.files.length > 0) {
                mergeName.textContent = mergeInput.files[0].name;
                mergeName.classList.add('selected');
                mergeBtn.disabled = false;
            } else {
                mergeName.textContent = 'Select legends_plus.xml';
                mergeName.classList.remove('selected');
                mergeBtn.disabled = true;
            }
        });

        mergeForm.addEventListener('submit', function() {
            mergeBtn.disabled = true;
            mergeBtn.innerHTML = '<span class="loading-spinner"></span> Merging...';
            mergeBtn.classList.add('loading');
        });
    }
})();
</script>

<div class="section">
    <h3>Import Data</h3>

    <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data" id="upload-form">
        <div class="upload-area" id="upload-area">
            <p>Upload your legends XML files</p>
            <div class="upload-inputs">
                <label class="upload-label">
                    <span class="upload-name" id="legends-name">legends.xml (required)</span>
                    <input type="file" name="legends" accept=".xml" id="legends-input">
                </label>
                <label class="upload-label">
                    <span class="upload-name" id="plus-name">legends_plus.xml (optional, DFHack)</span>
                    <input type="file" name="legends_plus" accept=".xml" id="plus-input">
                </label>
            </div>
            <button type="submit" class="btn btn-primary" id="upload-btn" disabled>Upload & Import</button>
        </div>
    </form>
    <p class="hint">This will clear existing data and import fresh from uploaded files.</p>

    <p><a href="{{ url_for('build_output') }}">View last import output</a></p>
</div>

<script>
(function() {
    var legendsInput = document.getElementById('legends-input');
    var plusInput = document.getElementById('plus-input');
    var legendsName = document.getElementById('legends-name');
    var plusName = document.getElementById('plus-name');
    var uploadBtn = document.getElementById('upload-btn');
    var uploadForm = document.getElementById('upload-form');
    var uploadArea = document.getElementById('upload-area');

    function updateState() {
        if (legendsInput.files.length > 0) {
            legendsName.textContent = legendsInput.files[0].name;
            legendsName.classList.add('selected');
            uploadBtn.disabled = false;
        } else {
            legendsName.textContent = 'legends.xml (required)';
            legendsName.classList.remove('selected');
            uploadBtn.disabled = true;
        }

        if (plusInput.files.length > 0) {
            plusName.textContent = plusInput.files[0].name;
            plusName.classList.add('selected');
        } else {
            plusName.textContent = 'legends_plus.xml (optional, DFHack)';
            plusName.classList.remove('selected');
        }
    }

    legendsInput.addEventListener('change', updateState);
    plusInput.addEventListener('change', updateState);

    // Handle form submission - show loading state
    uploadForm.addEventListener('submit', function(e) {
        // Show loading state after a brief delay to allow form submission
        setTimeout(function() {
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="loading-spinner"></span> Importing...';
            uploadBtn.classList.add('loading');
            uploadArea.classList.add('loading');
        }, 100);
    });
})();
</script>

{% if stats %}
<div class="section">
    <h3>Statistics</h3>
    <div class="stats-grid">
        {% for label, count in stats.items() %}
        {% set needs_plus = label in ['Entities', 'Written Works'] %}
        <div class="stat-card{% if needs_plus and current_world and not current_world.has_plus %} stat-disabled{% endif %}"
             {% if needs_plus and current_world and not current_world.has_plus %}title="Requires DFHack legends_plus.xml export"{% endif %}>
            <div class="stat-value">{{ "{:,}".format(count) }}</div>
            <div class="stat-label">
                {{ label }}
                {% if needs_plus and current_world and not current_world.has_plus %}
                <span class="stat-hint">DFHack</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
