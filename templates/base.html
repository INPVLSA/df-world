<!DOCTYPE html>
<html lang="en">
{% macro pagination(page, total_pages, base_url) %}
<div class="pagination">
    {# First and Previous #}
    {% if page > 1 %}
    <a href="{{ base_url }}&page=1" class="page-btn" title="First">&laquo;</a>
    <a href="{{ base_url }}&page={{ page - 1 }}" class="page-btn" title="Previous">&lsaquo;</a>
    {% else %}
    <span class="page-btn disabled">&laquo;</span>
    <span class="page-btn disabled">&lsaquo;</span>
    {% endif %}

    {# Page numbers #}
    {% set start_page = [page - 2, 1]|max %}
    {% set end_page = [page + 2, total_pages]|min %}

    {% if start_page > 1 %}
    <a href="{{ base_url }}&page=1" class="page-num">1</a>
    {% if start_page > 2 %}<span class="page-ellipsis">...</span>{% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
    {% if p == page %}
    <span class="page-num active">{{ p }}</span>
    {% else %}
    <a href="{{ base_url }}&page={{ p }}" class="page-num">{{ p }}</a>
    {% endif %}
    {% endfor %}

    {% if end_page < total_pages %}
    {% if end_page < total_pages - 1 %}<span class="page-ellipsis">...</span>{% endif %}
    <a href="{{ base_url }}&page={{ total_pages }}" class="page-num">{{ total_pages }}</a>
    {% endif %}

    {# Next and Last #}
    {% if page < total_pages %}
    <a href="{{ base_url }}&page={{ page + 1 }}" class="page-btn" title="Next">&rsaquo;</a>
    <a href="{{ base_url }}&page={{ total_pages }}" class="page-btn" title="Last">&raquo;</a>
    {% else %}
    <span class="page-btn disabled">&rsaquo;</span>
    <span class="page-btn disabled">&raquo;</span>
    {% endif %}
</div>
{% endmacro %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DF Tales{% endblock %}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='ico.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="{{ url_for('worlds.index') }}"><img src="{{ url_for('static', filename='ico.png') }}" alt="" class="nav-icon nav-logo" width="23" height="20">DF Tales</a>
            </div>
            <div class="nav-links">
                <a href="{{ url_for('pages.figures') }}"><img src="{{ url_for('static', filename='icons/races/DWARF.png') }}" alt="" class="nav-icon">Figures</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('pages.sites') }}"><img src="{{ url_for('static', filename='icons/sites/fortress.png') }}" alt="" class="nav-icon">Sites</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('pages.artifacts') }}"><img src="{{ url_for('static', filename='icons/artifact.png') }}" alt="" class="nav-icon">Artifacts</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('pages.written_content') }}"><img src="{{ url_for('static', filename='icons/artifacts/book.png') }}" alt="" class="nav-icon">Written</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('pages.world_map') }}"><img src="{{ url_for('static', filename='icons/map.png') }}" alt="" class="nav-icon">Map</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('pages.relations_graph') }}"><img src="{{ url_for('static', filename='icons/written/StarChart.png') }}" alt="" class="nav-icon">Graph</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('pages.events') }}"><img src="{{ url_for('static', filename='icons/scribe.png') }}" alt="" class="nav-icon">Events</a>
            </div>
        </div>
    </nav>

    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Entity Modal -->
    <div id="entity-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title"></span>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-loading">Loading...</div>
                <div class="modal-content"></div>
            </div>
        </div>
    </div>

    <div id="modal-history" class="modal-history" style="display: none;"></div>

    <script>
    // Global Entity Modal System
    window.EntityModal = (function() {
        var modal = document.getElementById('entity-modal');
        var modalTitle = modal.querySelector('.modal-title');
        var modalContent = modal.querySelector('.modal-content');
        var modalLoading = modal.querySelector('.modal-loading');
        var historyContainer = document.getElementById('modal-history');

        // History state
        var history = [];
        var MAX_HISTORY = 10;

        function addToHistory(type, id, name, race, siteType, raceImg) {
            // Don't add duplicate if same as last item
            if (history.length > 0) {
                var last = history[history.length - 1];
                if (last.type === type && last.id == id) return;
            }

            history.push({ type: type, id: id, name: name, race: race, siteType: siteType, raceImg: raceImg });

            // Limit history size
            if (history.length > MAX_HISTORY) {
                history.shift();
            }

            renderHistory();
        }

        function renderHistory() {
            if (history.length === 0) {
                historyContainer.style.display = 'none';
                return;
            }

            historyContainer.style.display = 'flex';
            var html = '';

            // Render bottom to top (oldest first in DOM, newest at top visually with flex-direction: column-reverse)
            history.forEach(function(item, idx) {
                var spriteUrl = '';
                if (item.type === 'figure' && item.raceImg) {
                    spriteUrl = item.raceImg;
                } else if (item.type === 'figure' && item.race) {
                    spriteUrl = '/static/icons/races/' + item.race + '.png';
                } else if (item.type === 'site' && item.siteType) {
                    spriteUrl = '/static/icons/sites/' + item.siteType.replace(/ /g, '_') + '.png';
                } else if (item.type === 'written') {
                    spriteUrl = '/static/icons/artifacts/book.png';
                } else if (item.type === 'artifact') {
                    spriteUrl = '/static/icons/artifact.png';
                }

                var isActive = idx === history.length - 1;
                var label = item.name ? titleCase(item.name) : item.type + ' #' + item.id;

                html += '<div class="history-item' + (isActive ? ' active' : '') + '" data-type="' + item.type + '" data-id="' + item.id + '">';
                if (spriteUrl) {
                    html += '<img src="' + spriteUrl + '" alt="" onerror="this.style.display=\'none\'">';
                }
                html += '<span class="history-label">' + label + '</span>';
                html += '</div>';
            });

            historyContainer.innerHTML = html;
        }

        function clearHistory() {
            history = [];
            historyContainer.style.display = 'none';
            historyContainer.innerHTML = '';
        }

        // Click handler for history items
        historyContainer.addEventListener('click', function(e) {
            var item = e.target.closest('.history-item');
            if (item) {
                load(item.dataset.type, item.dataset.id);
            }
        });
        var closeBtn = modal.querySelector('.modal-close');

        function titleCase(str) {
            if (!str) return '-';
            return str.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
        }

        function formatLinkType(linkType) {
            if (!linkType) return '';
            return linkType.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
        }

        function formatEntityFallback(entity) {
            // When entity has no name, show type + race as fallback
            var parts = [];
            if (entity.entity_race) {
                parts.push(titleCase(entity.entity_race.replace(/_/g, ' ')));
            }
            if (entity.entity_type) {
                parts.push(titleCase(entity.entity_type.replace(/_/g, ' ')));
            }
            if (parts.length > 0) {
                return parts.join(' ') + ' #' + entity.entity_id;
            }
            return 'Entity #' + entity.entity_id;
        }

        // Render a site link with sprite icon
        function renderSiteLink(siteId, siteName, siteType) {
            var sprite = '';
            if (siteType) {
                var siteTypeKey = siteType.replace(/ /g, '_');
                sprite = '<img src="/static/icons/sites/' + siteTypeKey + '.png" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
            }
            var name = siteName ? titleCase(siteName) : 'Site #' + siteId;
            return sprite + '<a href="#" class="entity-link" data-type="site" data-id="' + siteId + '">' + name + '</a>';
        }

        // Render an artifact link with sprite icon
        function renderArtifactLink(artifactId, artifactName, artifactType) {
            var sprite = '';
            if (artifactType) {
                sprite = '<img src="/static/icons/artifacts/' + artifactType + '.png" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
            }
            var name = artifactName ? titleCase(artifactName) : 'Artifact #' + artifactId;
            return sprite + '<a href="#" class="entity-link" data-type="artifact" data-id="' + artifactId + '">' + name + '</a>';
        }

        // Render a written content link with sprite icon
        function renderWrittenLink(writtenId, writtenTitle, writtenType) {
            var sprite = '<img src="/static/icons/artifacts/book.png" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
            if (writtenType) {
                var typeIcon = '/static/icons/written/' + writtenType + '.png';
                sprite = '<img src="' + typeIcon + '" class="inline-icon" alt="" onerror="this.src=\'/static/icons/artifacts/book.png\'">';
            }
            var name = writtenTitle ? titleCase(writtenTitle) : 'Written Content #' + writtenId;
            return sprite + '<a href="#" class="entity-link" data-type="written" data-id="' + writtenId + '">' + name + '</a>';
        }

        // Event state icons mapping
        var EVENT_STATE_ICONS = {
            'refugee': '/static/icons/events/refugee.png',
            'settler': '/static/icons/events/settler.png',
            'visitor': '/static/icons/events/visitor.png',
            'wanderer': '/static/icons/events/wanderer.png'
        };

        // Job category icons mapping
        var JOB_CATEGORY_ICONS = {
            food: '/static/icons/events/job_food.png',
            farming: '/static/icons/events/job_farming.png',
            mining: '/static/icons/events/job_mining.png',
            woodwork: '/static/icons/events/job_woodwork.png',
            metalwork: '/static/icons/events/job_metalwork.png',
            cloth: '/static/icons/events/job_cloth.png',
            military: '/static/icons/events/job_military.png',
            scholar: '/static/icons/events/job_scholar.png',
            arts: '/static/icons/events/job_arts.png',
            religious: '/static/icons/events/job_religious.png',
            trade: '/static/icons/events/job_trade.png',
            criminal: '/static/icons/events/job_criminal.png',
            other: '/static/icons/events/job_other.png'
        };

        // Map jobs to categories
        var JOB_CATEGORIES = {
            // Food
            cook: 'food', brewer: 'food', butcher: 'food', cheese_maker: 'food',
            fish_cleaner: 'food', fish_dissector: 'food', miller: 'food',
            // Farming/Animals
            farmer: 'farming', planter: 'farming', animal_caretaker: 'farming',
            animal_trainer: 'farming', animal_dissector: 'farming', beekeeper: 'farming',
            milker: 'farming', shearer: 'farming', gelder: 'farming', thresher: 'farming',
            herbalist: 'farming', presser: 'farming',
            // Mining/Stonework
            miner: 'mining', mason: 'mining', gem_cutter: 'mining',
            // Woodwork
            carpenter: 'woodwork', woodcutter: 'woodwork', wood_burner: 'woodwork', bowyer: 'woodwork',
            // Metalwork
            blacksmith: 'metalwork', armorer: 'metalwork', weaponsmith: 'metalwork',
            metalcrafter: 'metalwork', bone_carver: 'metalwork',
            // Cloth/Leather
            clothier: 'cloth', weaver: 'cloth', spinner: 'cloth', tanner: 'cloth',
            leatherworker: 'cloth', lye_maker: 'cloth', soap_maker: 'cloth',
            // Military/Combat
            mercenary: 'military', beast_hunter: 'military', monster_slayer: 'military',
            ranger: 'military', scout: 'military', hunter: 'military', trapper: 'military',
            // Scholars
            astronomer: 'scholar', mathematician: 'scholar', geographer: 'scholar',
            naturalist: 'scholar', historian: 'scholar', philosopher: 'scholar',
            engineer: 'scholar', doctor: 'scholar', chemist: 'scholar',
            // Arts/Entertainment
            bard: 'arts', dancer: 'arts', poet: 'arts',
            // Religious
            monk: 'religious', pilgrim: 'religious', prophet: 'religious',
            // Trade
            merchant: 'trade', peddler: 'trade', tavern_keeper: 'trade',
            // Criminal
            criminal: 'criminal', thief: 'criminal', snatcher: 'criminal'
        };

        function getJobIcon(job) {
            if (!job) return null;
            var category = JOB_CATEGORIES[job] || 'other';
            return JOB_CATEGORY_ICONS[category];
        }

        function getEventIcon(ev) {
            var extra = {};
            if (ev.extra_data) {
                try { extra = JSON.parse(ev.extra_data); } catch(e) {}
            }
            var type = (ev.type || '').replace(/ /g, '_');

            // State change icons
            if (type === 'change_hf_state') {
                var state = ev.state || extra.state;
                if (state && EVENT_STATE_ICONS[state]) {
                    return '<img src="' + EVENT_STATE_ICONS[state] + '" class="event-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            }

            // Job change icons
            if (type === 'change_hf_job') {
                var job = extra.new_job;
                var iconPath = getJobIcon(job);
                if (iconPath) {
                    return '<img src="' + iconPath + '" class="event-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            }

            // Death event icons (handled separately in formatEventDescription for context)

            return '';
        }

        function formatEventDescription(ev, figId) {
            var parts = [];
            var extra = {};
            if (ev.extra_data) {
                try { extra = JSON.parse(ev.extra_data); } catch(e) {}
            }

            var type = (ev.type || '').replace(/ /g, '_');

            // Site reference
            if (ev.site_name) {
                parts.push('at ' + renderSiteLink(ev.site_id, ev.site_name, ev.site_type));
            }

            // Death events
            if (type === 'hist_figure_died') {
                var cause = ev.death_cause || extra.death_cause;
                var victimId = ev.victim_hfid || extra.victim_hf;

                // This figure is the slayer - show who they killed
                if (ev.victim_name && ev.slayer_hfid == figId) {
                    var victimSprite = '';
                    if (ev.victim_race) {
                        victimSprite = '<img src="/static/icons/races/' + ev.victim_race + '.png" class="event-icon" alt="" onerror="this.style.display=\'none\'">';
                    }
                    var killedIcon = '<img src="/static/icons/events/killed.png" class="event-icon" alt="">';
                    parts.unshift(killedIcon + ' killed ' + victimSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + ev.victim_hfid + '">' + titleCase(ev.victim_name) + '</a>');
                }
                // This figure is the victim - show their death
                else if (victimId == figId) {
                    var diedIcon = '<img src="/static/icons/events/died.png" class="event-icon" alt="">';
                    if (ev.slayer_name) {
                        var slayerSprite = '';
                        if (ev.slayer_race) {
                            slayerSprite = '<img src="/static/icons/races/' + ev.slayer_race + '.png" class="event-icon" alt="" onerror="this.style.display=\'none\'">';
                        }
                        parts.unshift(diedIcon + ' died, killed by ' + slayerSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + ev.slayer_hfid + '">' + titleCase(ev.slayer_name) + '</a>');
                    } else {
                        parts.unshift(diedIcon + ' died');
                    }
                }
                // Fallback for other death events
                else if (ev.slayer_name) {
                    parts.unshift('killed by <a href="#" class="entity-link" data-type="figure" data-id="' + ev.slayer_hfid + '">' + titleCase(ev.slayer_name) + '</a>');
                }

                if (cause) {
                    parts.push('(' + cause.replace(/_/g, ' ') + ')');
                }
            }

            // Relationship events
            if (type === 'add_hf_hf_link' || type === 'remove_hf_hf_link') {
                if (ev.hfid2_name) {
                    var rel = extra.link_type ? extra.link_type.replace(/_/g, ' ') : 'relationship';
                    var verb = type === 'add_hf_hf_link' ? 'formed' : 'ended';
                    parts.unshift(verb + ' ' + rel + ' with <a href="#" class="entity-link" data-type="figure" data-id="' + ev.hfid2 + '">' + titleCase(ev.hfid2_name) + '</a>');
                }
            }

            // Entity link events
            if (type === 'add_hf_entity_link' || type === 'remove_hf_entity_link') {
                var linkType = extra.link_type || '';
                var entityId = ev.civ_id || ev.entity_id || extra.civ_id || extra.entity_id;
                if (entityId) {
                    parts.unshift('<a href="#" class="entity-link" data-type="entity" data-id="' + entityId + '">Entity #' + entityId + '</a>');
                }
                if (linkType) {
                    parts.unshift(linkType.replace(/_/g, ' '));
                }
            }

            // State change
            if (type === 'change_hf_state') {
                var state = ev.state || extra.state;
                if (state) {
                    parts.unshift('became ' + state.replace(/_/g, ' '));
                }
            }

            // Job change
            if (type === 'change_hf_job') {
                var newJob = extra.new_job;
                if (newJob) {
                    parts.unshift('became ' + newJob.replace(/_/g, ' '));
                }
            }

            // Artifact created
            if (type === 'artifact_created') {
                var artifactId = ev.artifact_id || extra.artifact_id;
                if (artifactId) {
                    parts.unshift('created ' + renderArtifactLink(artifactId, ev.artifact_name, ev.artifact_type));
                }
            }

            return parts.join(' ');
        }

        function getTitleWithSprite(type, data) {
            var name, sprite = '';
            if (type === 'figure' && data.figure) {
                name = data.figure.name;
                var raceImg = data.figure.race_img;
                if (raceImg) {
                    sprite = '<img src="' + raceImg + '" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                } else if (data.figure.race) {
                    var imgPath = '/static/icons/races/' + data.figure.race + '.png';
                    sprite = '<img src="' + imgPath + '" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            } else if (type === 'site' && data.site) {
                name = data.site.name;
                var siteType = data.site.type;
                if (siteType) {
                    var imgPath = '/static/icons/sites/' + siteType.replace(/ /g, '_') + '.png';
                    sprite = '<img src="' + imgPath + '" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            } else if (type === 'artifact' && data.artifact) {
                name = data.artifact.name;
                var artType = data.artifact.item_type;
                if (artType) {
                    sprite = '<img src="/static/icons/artifacts/' + artType + '.png" class="modal-title-icon" alt="" onerror="this.src=\'/static/icons/artifact.png\'">';
                } else {
                    sprite = '<img src="/static/icons/artifact.png" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            } else if (type === 'entity' && data.entity) {
                name = data.entity.name;
                // If no name, build a fallback from race + type
                if (!name) {
                    var parts = [];
                    if (data.entity.race) {
                        parts.push(titleCase(data.entity.race.replace(/_/g, ' ')));
                    }
                    if (data.entity.type) {
                        parts.push(titleCase(data.entity.type.replace(/_/g, ' ')));
                    }
                    if (parts.length > 0) {
                        name = parts.join(' ');
                    }
                }
                // Use entity type icon if available, fallback to race icon
                var entType = data.entity.type;
                if (entType) {
                    var imgPath = '/static/icons/entities/' + entType + '.png';
                    sprite = '<img src="' + imgPath + '" class="modal-title-icon" alt="" onerror="this.onerror=null; var race=\'' + (data.entity.race || '') + '\'; if(race) { this.src=\'/static/icons/races/\'+race.toUpperCase()+\'.png\'; } else { this.style.display=\'none\'; }">';
                } else {
                    var race = data.entity.race;
                    if (race) {
                        var imgPath = '/static/icons/races/' + race.toUpperCase() + '.png';
                        sprite = '<img src="' + imgPath + '" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                    }
                }
            } else if (type === 'written' && data.written) {
                name = data.written.title;
                var wcType = data.written.type;
                if (data.written.type_img) {
                    sprite = '<img src="' + data.written.type_img + '" class="modal-title-icon" alt="" onerror="this.src=\'/static/icons/artifacts/book.png\'">';
                } else {
                    sprite = '<img src="/static/icons/artifacts/book.png" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            }
            if (name) {
                return sprite + titleCase(name);
            }
            return null;
        }

        function show(title) {
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalLoading.style.display = 'block';
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function hide() {
            modal.style.display = 'none';
            document.body.style.overflow = '';
            clearHistory();
        }

        function setContent(html) {
            modalLoading.style.display = 'none';
            modalContent.innerHTML = html;
        }

        function setError(msg) {
            modalLoading.style.display = 'none';
            modalContent.innerHTML = '<div class="modal-error">' + msg + '</div>';
        }

        // Renderers for each entity type
        var renderers = {
            figure: function(data) {
                var fig = data.figure;
                var html = '<div class="entity-details">';
                html += '<div class="entity-row"><span class="entity-label">Race:</span> ' + (fig.race_label || '-') + '</div>';
                if (fig.caste) {
                    var casteVal = fig.caste.toLowerCase();
                    if (casteVal === 'male' || casteVal === 'female') {
                        html += '<div class="entity-row"><span class="entity-label">Sex:</span> ' + titleCase(fig.caste) + '</div>';
                    } else {
                        html += '<div class="entity-row"><span class="entity-label">Caste:</span> ' + titleCase(fig.caste) + '</div>';
                    }
                }
                html += '<div class="entity-row"><span class="entity-label">Born:</span> ' + (fig.birth_year != null ? fig.birth_year : '-') + '</div>';
                html += '<div class="entity-row"><span class="entity-label">Died:</span> ' + (fig.death_year == -1 ? '<span class="alive">Alive</span>' : (fig.death_year || '-')) + '</div>';
                if (fig.birth_year != null && fig.age != null) {
                    html += '<div class="entity-row"><span class="entity-label">Age:</span> ' + fig.age + '</div>';
                }

                // Affiliations
                if (data.affiliations && data.affiliations.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Affiliations (' + data.affiliations.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="5">';
                    data.affiliations.forEach(function(aff, idx) {
                        var name = aff.entity_name ? titleCase(aff.entity_name) : formatEntityFallback(aff);
                        var linkType = formatLinkType(aff.link_type);
                        var hiddenClass = idx >= 5 ? ' hidden-item' : '';
                        // Entity sprite - try entity type icon first, fallback to race
                        var sprite = '';
                        if (aff.entity_type) {
                            sprite = '<img src="/static/icons/entities/' + aff.entity_type + '.png" class="inline-icon" alt="" onerror="this.onerror=null; var race=\'' + (aff.entity_race || '') + '\'; if(race) { this.src=\'/static/icons/races/\'+race.toUpperCase()+\'.png\'; } else { this.style.display=\'none\'; }">';
                        } else if (aff.entity_race) {
                            sprite = '<img src="/static/icons/races/' + aff.entity_race.toUpperCase() + '.png" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
                        }
                        html += '<div class="entity-list-item' + hiddenClass + '"><span class="link-type">' + linkType + '</span>: ';
                        html += sprite + '<a href="#" class="entity-link" data-type="entity" data-id="' + aff.entity_id + '">' + name + '</a></div>';
                    });
                    if (data.affiliations.length > 5) {
                        html += '<div class="expand-more-btn" data-count="' + (data.affiliations.length - 5) + '">... and ' + (data.affiliations.length - 5) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Site links
                if (data.site_links && data.site_links.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Site Links (' + data.site_links.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="5">';
                    data.site_links.forEach(function(sl, idx) {
                        var linkType = formatLinkType(sl.link_type);
                        var hiddenClass = idx >= 5 ? ' hidden-item' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '"><span class="link-type">' + linkType + '</span>: ';
                        html += renderSiteLink(sl.site_id, sl.site_name, sl.site_type) + '</div>';
                    });
                    if (data.site_links.length > 5) {
                        html += '<div class="expand-more-btn" data-count="' + (data.site_links.length - 5) + '">... and ' + (data.site_links.length - 5) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Relationships - grouped by type
                if (data.relationships && data.relationships.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Relationships (' + data.relationships.length + ')</div>';

                    // Group by relationship type
                    var grouped = {};
                    data.relationships.forEach(function(rel) {
                        var relType = rel.relationship || 'related';
                        if (!grouped[relType]) grouped[relType] = [];
                        grouped[relType].push(rel);
                    });

                    // Render each group
                    Object.keys(grouped).forEach(function(relType) {
                        var items = grouped[relType];
                        var label = relType.replace(/_/g, ' ');
                        html += '<div class="rel-group"><span class="rel-group-label">' + titleCase(label) + ' (' + items.length + ')</span>';
                        html += '<div class="rel-group-items">';
                        items.forEach(function(rel) {
                            var sprite = '';
                            if (rel.related_race_img) {
                                sprite = '<img src="' + rel.related_race_img + '" class="event-icon" alt="" onerror="this.style.display=\'none\'">';
                            } else if (rel.related_race) {
                                sprite = '<img src="/static/icons/races/' + rel.related_race + '.png" class="event-icon" alt="" onerror="this.style.display=\'none\'">';
                            }
                            var name = rel.related_name ? titleCase(rel.related_name) : 'Figure #' + (rel.source_hf == fig.id ? rel.target_hf : rel.source_hf);
                            var targetId = rel.source_hf == fig.id ? rel.target_hf : rel.source_hf;
                            html += '<div class="relationship-item">' + sprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + targetId + '">' + name + '</a></div>';
                        });
                        html += '</div></div>';
                    });

                    html += '</div>';
                }

                // Life events / history
                if (data.events && data.events.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Life Events (' + data.events.length + (data.events.length >= 100 ? '+' : '') + ')</div>';
                    html += '<div class="timeline">';
                    var lastYear = null;
                    var birthYear = fig.birth_year;
                    data.events.forEach(function(ev) {
                        var yearChanged = ev.year !== lastYear;
                        if (yearChanged) {
                            var ageStr = '';
                            if (birthYear != null && ev.year != null && ev.year >= birthYear) {
                                var age = ev.year - birthYear;
                                ageStr = ' <span class="timeline-age">(age ' + age + ')</span>';
                            }
                            html += '<div class="timeline-year">' + (ev.year || '?') + ageStr + '</div>';
                            lastYear = ev.year;
                        }
                        html += '<div class="timeline-event">';
                        // Event icon
                        var icon = getEventIcon(ev);
                        if (icon) {
                            html += icon;
                        }
                        // Build description
                        var desc = formatEventDescription(ev, fig.id);
                        if (desc) {
                            html += '<span class="timeline-desc">' + desc + '</span>';
                        }
                        html += '</div>';
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                html += '<div class="modal-footer">';
                html += '<a href="/graph?figure=' + fig.id + '" class="btn btn-sm">View Graph</a> ';
                html += '<a href="/figures?q=' + encodeURIComponent(fig.name || '') + '" class="btn btn-sm">View in List</a>';
                html += '</div>';
                return html;
            },

            site: function(data) {
                var site = data.site;
                var html = '<div class="entity-details">';
                html += '<div class="entity-row"><span class="entity-label">Type:</span> ' + (site.type_label || site.type || '-') + '</div>';
                html += '<div class="entity-row"><span class="entity-label">Coords:</span> ' + (site.coords || '-') + '</div>';
                if (site.civ_name) {
                    html += '<div class="entity-row"><span class="entity-label">Civilization:</span> ';
                    html += '<a href="#" class="entity-link" data-type="entity" data-id="' + site.civ_id + '">' + titleCase(site.civ_name) + '</a></div>';
                }
                if (site.owner_name && site.cur_owner_id !== site.civ_id) {
                    html += '<div class="entity-row"><span class="entity-label">Current Owner:</span> ';
                    html += '<a href="#" class="entity-link" data-type="entity" data-id="' + site.cur_owner_id + '">' + titleCase(site.owner_name) + '</a></div>';
                }

                // Structures
                if (data.structures && data.structures.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Structures (' + data.structures.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="10">';
                    data.structures.forEach(function(st, idx) {
                        var hiddenClass = idx >= 10 ? ' hidden-item' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '">' + (st.type_label || st.type || 'Structure') + ': ' + titleCase(st.name) + '</div>';
                    });
                    if (data.structures.length > 10) {
                        html += '<div class="expand-more-btn" data-count="' + (data.structures.length - 10) + '">... and ' + (data.structures.length - 10) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Current Settlers (alive figures at site)
                if (data.settlers && data.settlers.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Current Settlers (' + data.settlers.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="10">';
                    data.settlers.forEach(function(fig, idx) {
                        var hiddenClass = idx >= 10 ? ' hidden-item' : '';
                        var sprite = fig.race_img
                            ? '<img src="' + fig.race_img + '" class="inline-icon" alt="">'
                            : '<span class="inline-icon-text">' + (fig.race_icon || '?') + '</span>';
                        var linkType = fig.link_type ? ' <span class="link-type">(' + fig.link_type.replace(/_/g, ' ') + ')</span>' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '">' + sprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + fig.id + '">' + titleCase(fig.name) + '</a>' + linkType + '</div>';
                    });
                    if (data.settlers.length > 10) {
                        html += '<div class="expand-more-btn" data-count="' + (data.settlers.length - 10) + '">... and ' + (data.settlers.length - 10) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Linked Figures
                if (data.linked_figures && data.linked_figures.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Linked Figures (' + data.linked_figures.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="10">';
                    data.linked_figures.forEach(function(fig, idx) {
                        var hiddenClass = idx >= 10 ? ' hidden-item' : '';
                        var sprite = fig.race_img
                            ? '<img src="' + fig.race_img + '" class="inline-icon" alt="">'
                            : '<span class="inline-icon-text">' + (fig.race_icon || '?') + '</span>';
                        var linkType = fig.link_type ? ' <span class="link-type">(' + fig.link_type.replace(/_/g, ' ') + ')</span>' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '">' + sprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + fig.id + '">' + titleCase(fig.name) + '</a>' + linkType + '</div>';
                    });
                    if (data.linked_figures.length > 10) {
                        html += '<div class="expand-more-btn" data-count="' + (data.linked_figures.length - 10) + '">... and ' + (data.linked_figures.length - 10) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Artifacts
                if (data.artifacts && data.artifacts.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Artifacts (' + data.artifacts.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="5">';
                    data.artifacts.forEach(function(art, idx) {
                        var hiddenClass = idx >= 5 ? ' hidden-item' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '">' + renderArtifactLink(art.id, art.name, art.item_type) + '</div>';
                    });
                    if (data.artifacts.length > 5) {
                        html += '<div class="expand-more-btn" data-count="' + (data.artifacts.length - 5) + '">... and ' + (data.artifacts.length - 5) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Events (using timeline format like figure modal)
                if (data.events && data.events.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Recent Events (' + data.events.length + ')</div>';
                    html += '<div class="timeline-events site-events">';
                    var lastYear = null;
                    var eventCount = 0;
                    data.events.forEach(function(ev, idx) {
                        // For site context, show figure name first
                        var desc = formatEventDescription(ev, null);
                        var prefix = '';
                        if (ev.hf_name) {
                            var figSprite = ev.hf_race ? '<img src="/static/icons/races/' + ev.hf_race.toUpperCase() + '.png" class="event-icon" alt="" onerror="this.style.display=\'none\'">' : '';
                            prefix = figSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + ev.hfid + '">' + titleCase(ev.hf_name) + '</a> ';
                        }
                        // Skip events with no content
                        if (!desc && !prefix) return;

                        var yearChanged = ev.year !== lastYear;
                        if (yearChanged) {
                            html += '<div class="timeline-year">' + (ev.year || '?') + '</div>';
                            lastYear = ev.year;
                        }
                        html += '<div class="timeline-event">';
                        var icon = getEventIcon(ev);
                        if (icon) html += icon;
                        html += '<span class="timeline-desc">' + prefix + (desc || '') + '</span>';
                        html += '</div>';
                        eventCount++;
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                html += '<div class="modal-footer">';
                if (site.coords) {
                    html += '<a href="/map#site-' + site.id + '" class="btn btn-sm site-map-btn" data-site-id="' + site.id + '" data-coords="' + site.coords + '">View on Map</a> ';
                }
                html += '<a href="/sites?q=' + encodeURIComponent(site.name || '') + '" class="btn btn-sm">View in List</a>';
                html += '</div>';
                return html;
            },

            artifact: function(data) {
                var art = data.artifact;
                var html = '<div class="entity-details">';
                html += '<div class="entity-row"><span class="entity-label">Type:</span> ' + (art.item_type ? art.item_type.replace(/_/g, ' ') : '-') + '</div>';
                if (art.item_subtype) {
                    html += '<div class="entity-row"><span class="entity-label">Subtype:</span> ' + art.item_subtype.replace(/_/g, ' ') + '</div>';
                }
                html += '<div class="entity-row"><span class="entity-label">Material:</span> ' + (art.mat ? art.mat.replace(/_/g, ' ') : '-') + '</div>';

                if (art.creator_name) {
                    var creatorSprite = '';
                    if (art.creator_race_img) {
                        creatorSprite = '<img src="' + art.creator_race_img + '" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
                    }
                    html += '<div class="entity-row"><span class="entity-label">Creator:</span> ';
                    html += creatorSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + art.creator_hfid + '">' + titleCase(art.creator_name) + '</a></div>';
                }
                if (art.site_name) {
                    html += '<div class="entity-row"><span class="entity-label">Created at:</span> ';
                    html += renderSiteLink(art.site_id, art.site_name, art.site_type) + '</div>';
                }
                if (art.holder_name) {
                    var holderSprite = '';
                    if (art.holder_race_img) {
                        holderSprite = '<img src="' + art.holder_race_img + '" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
                    }
                    html += '<div class="entity-row"><span class="entity-label">Held by:</span> ';
                    html += holderSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + art.holder_hfid + '">' + titleCase(art.holder_name) + '</a></div>';
                }

                // Written contents (for books/scrolls)
                if (data.written_contents && data.written_contents.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Contains (' + data.written_contents.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="5">';
                    data.written_contents.forEach(function(wc, idx) {
                        var hiddenClass = idx >= 5 ? ' hidden-item' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '">' + renderWrittenLink(wc.id, wc.title, wc.type) + '</div>';
                    });
                    if (data.written_contents.length > 5) {
                        html += '<div class="expand-more-btn" data-count="' + (data.written_contents.length - 5) + '">... and ' + (data.written_contents.length - 5) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Artifact history/events
                if (data.events && data.events.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">History (' + data.events.length + ')</div>';
                    html += '<div class="timeline">';
                    var lastYear = null;
                    data.events.forEach(function(ev) {
                        var yearChanged = ev.year !== lastYear;
                        if (yearChanged) {
                            html += '<div class="timeline-year">' + (ev.year || '?') + '</div>';
                            lastYear = ev.year;
                        }
                        html += '<div class="timeline-event">';

                        // Build event description
                        var desc = '';
                        var evType = (ev.type || '').replace(/_/g, ' ');

                        // Death events with slayer/victim
                        if (ev.type === 'hist_figure_died' && (ev.slayer_name || ev.victim_name)) {
                            var killedIcon = '<img src="/static/icons/events/killed.png" class="event-icon" alt="" onerror="this.style.display=\'none\'">';

                            // Slayer
                            if (ev.slayer_name) {
                                var slayerSprite = ev.slayer_race_img ? '<img src="' + ev.slayer_race_img + '" class="event-icon" alt="" onerror="this.style.display=\'none\'">' : '';
                                desc += slayerSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + ev.slayer_hfid + '">' + titleCase(ev.slayer_name) + '</a>';
                            } else {
                                desc += 'Someone';
                            }

                            desc += ' ' + killedIcon + ' killed ';

                            // Victim
                            if (ev.victim_name) {
                                var victimSprite = ev.victim_race_img ? '<img src="' + ev.victim_race_img + '" class="event-icon" alt="" onerror="this.style.display=\'none\'">' : '';
                                desc += victimSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + ev.victim_hfid + '">' + titleCase(ev.victim_name) + '</a>';
                            } else {
                                desc += 'someone';
                            }

                            // Death cause
                            if (ev.death_cause) {
                                desc += ' (' + ev.death_cause.replace(/_/g, ' ') + ')';
                            }
                        }
                        // Item stolen events
                        else if (ev.type === 'item_stolen') {
                            // Thief
                            if (ev.hf_name) {
                                var thiefSprite = ev.hf_race_img ? '<img src="' + ev.hf_race_img + '" class="event-icon" alt="" onerror="this.style.display=\'none\'">' : '';
                                desc += thiefSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + ev.hfid + '">' + titleCase(ev.hf_name) + '</a> ';
                            }

                            // Theft method determines verb
                            var method = ev.extra && ev.extra.theft_method;
                            if (method === 'looted') {
                                desc += 'looted this artifact';
                            } else if (method === 'recovered') {
                                desc += 'recovered this artifact';
                            } else {
                                desc += 'stole this artifact';
                            }

                            // From defeated figure (for looted)
                            if (ev.defeated_name) {
                                var defeatedSprite = ev.defeated_race_img ? '<img src="' + ev.defeated_race_img + '" class="event-icon" alt="" onerror="this.style.display=\'none\'">' : '';
                                desc += ' from ' + defeatedSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + ev.defeated_hfid + '">' + titleCase(ev.defeated_name) + '</a>';
                            }
                            // From entity
                            else if (ev.entity_name) {
                                desc += ' from <a href="#" class="entity-link" data-type="entity" data-id="' + ev.entity_id + '">' + titleCase(ev.entity_name) + '</a>';
                            }
                        } else {
                            // Figure involved (for non-death events)
                            if (ev.hf_name) {
                                var figSprite = ev.hf_race_img ? '<img src="' + ev.hf_race_img + '" class="event-icon" alt="" onerror="this.style.display=\'none\'">' : '';
                                desc += figSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + ev.hfid + '">' + titleCase(ev.hf_name) + '</a> ';
                            }

                            // Event type label
                            var typeLabel = ev.type_label || evType;
                            if (ev.type === 'artifact_created') {
                                desc += 'created this artifact';
                            } else if (ev.type === 'artifact_stored') {
                                desc += 'stored this artifact';
                            } else if (ev.type === 'artifact_lost') {
                                desc += 'lost this artifact';
                            } else if (ev.type === 'artifact_found') {
                                desc += 'found this artifact';
                            } else if (ev.type === 'artifact_given') {
                                desc += 'received this artifact';
                            } else if (ev.type === 'artifact_claimed') {
                                desc += 'claimed this artifact';
                            } else if (ev.type === 'artifact_destroyed') {
                                desc += 'destroyed this artifact';
                            } else if (ev.type === 'artifact_transformed') {
                                desc += 'transformed this artifact';
                            } else if (ev.type === 'artifact_copied') {
                                desc += 'copied this artifact';
                            } else if (ev.type === 'artifact_recovered') {
                                desc += 'recovered this artifact';
                            } else {
                                desc += typeLabel;
                            }
                        }

                        // Site reference
                        if (ev.site_name) {
                            desc += ' at ' + renderSiteLink(ev.site_id, ev.site_name, ev.site_type);
                        }

                        html += '<span class="timeline-desc">' + desc + '</span>';
                        html += '</div>';
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                html += '<div class="modal-footer"><a href="/artifacts?q=' + encodeURIComponent(art.name || '') + '" class="btn btn-sm">View in List</a></div>';
                return html;
            },

            entity: function(data) {
                var ent = data.entity;
                var html = '<div class="entity-details">';
                var typeLabel = (ent.type || '-').replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
                html += '<div class="entity-row"><span class="entity-label">Type:</span> ' + typeLabel + '</div>';
                html += '<div class="entity-row"><span class="entity-label">Race:</span> ' + (ent.race_label || ent.race || '-') + '</div>';

                // Positions - grouped by hierarchy
                if (data.positions && data.positions.length > 0) {
                    var categories = {
                        rulers: { label: 'Rulers', icon: '', positions: [], keywords: ['king', 'queen', 'emperor', 'empress', 'monarch', 'lord', 'lady', 'duke', 'duchess', 'baron', 'count', 'earl', 'mayor', 'chief', 'law-giver', 'ruler'] },
                        military: { label: 'Military', icon: '', positions: [], keywords: ['general', 'captain', 'commander', 'marshal', 'warlord', 'military', 'guard', 'soldier', 'warrior', 'knight', 'executioner', 'constable', 'sheriff', 'militia'] },
                        religious: { label: 'Religious', icon: '', positions: [], keywords: ['priest', 'high priest', 'prophet', 'oracle', 'druid', 'shaman', 'bishop', 'cleric', 'religious', 'holy', 'divine'] },
                        admin: { label: 'Administration', icon: '', positions: [], keywords: ['counselor', 'advisor', 'minister', 'chancellor', 'secretary', 'administrator', 'keeper', 'treasurer', 'chamberlain', 'steward', 'manager', 'bookkeeper', 'seal'] },
                        services: { label: 'Services', icon: '', positions: [], keywords: ['chef', 'cook', 'doctor', 'physician', 'healer', 'butler', 'servant', 'maid', 'caretaker', 'beast', 'animal', 'stable', 'cup-bearer', 'food', 'drink', 'grain', 'brewer', 'farmer'] },
                        other: { label: 'Other', icon: '', positions: [] }
                    };

                    data.positions.forEach(function(pos) {
                        var nameLower = (pos.name || '').toLowerCase();
                        var categorized = false;
                        for (var cat in categories) {
                            if (cat === 'other') continue;
                            var found = categories[cat].keywords.some(function(kw) {
                                return nameLower.indexOf(kw) !== -1;
                            });
                            if (found) {
                                categories[cat].positions.push(pos);
                                categorized = true;
                                break;
                            }
                        }
                        if (!categorized) {
                            categories.other.positions.push(pos);
                        }
                    });

                    html += '<div class="entity-section"><div class="entity-section-title">Positions (' + data.positions.length + ')</div>';
                    html += '<div class="positions-hierarchy">';

                    ['rulers', 'military', 'religious', 'admin', 'services', 'other'].forEach(function(catKey) {
                        var cat = categories[catKey];
                        if (cat.positions.length === 0) return;

                        html += '<div class="position-category">';
                        html += '<div class="position-category-header"><span class="category-icon">' + cat.icon + '</span> ' + cat.label + ' (' + cat.positions.length + ')</div>';
                        html += '<div class="position-category-list expandable-list" data-limit="5">';
                        cat.positions.forEach(function(pos, idx) {
                            var holder = '';
                            if (pos.holder_name) {
                                var sprite = pos.holder_race ? '<img src="/static/icons/races/' + pos.holder_race + '.png" class="inline-icon" alt="" onerror="this.style.display=\'none\'">' : '';
                                holder = ' - ' + sprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + pos.histfig_id + '">' + titleCase(pos.holder_name) + '</a>';
                            } else {
                                holder = ' - <span class="vacant">Vacant</span>';
                            }
                            var hiddenClass = idx >= 5 ? ' hidden-item' : '';
                            html += '<div class="entity-list-item position-item' + hiddenClass + '">' + titleCase(pos.name) + holder + '</div>';
                        });
                        if (cat.positions.length > 5) {
                            html += '<div class="expand-more-btn" data-count="' + (cat.positions.length - 5) + '">... and ' + (cat.positions.length - 5) + ' more</div>';
                        }
                        html += '</div></div>';
                    });

                    html += '</div></div>';
                }

                html += '</div>';
                return html;
            },

            written: function(data) {
                var wc = data.written;
                var html = '<div class="entity-details">';

                // Type with color
                var typeLabel = (wc.type_label || wc.type || '-').replace(/_/g, ' ');
                var typeStyle = wc.type_color ? ' style="color: ' + wc.type_color + '"' : '';
                html += '<div class="entity-row"><span class="entity-label">Type:</span> <span' + typeStyle + '>' + typeLabel + '</span></div>';

                // Author
                if (wc.author_name) {
                    var authorSprite = '';
                    if (wc.author_race_img) {
                        authorSprite = '<img src="' + wc.author_race_img + '" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
                    }
                    html += '<div class="entity-row"><span class="entity-label">Author:</span> ' + authorSprite + '<a href="#" class="entity-link" data-type="figure" data-id="' + wc.author_hfid + '">' + titleCase(wc.author_name) + '</a></div>';
                }

                // Page range
                if (wc.page_start != null && wc.page_end != null) {
                    if (wc.page_start === wc.page_end) {
                        html += '<div class="entity-row"><span class="entity-label">Page:</span> ' + wc.page_start + '</div>';
                    } else {
                        html += '<div class="entity-row"><span class="entity-label">Pages:</span> ' + wc.page_start + ' - ' + wc.page_end + '</div>';
                    }
                }

                // Styles
                if (wc.styles && wc.styles.length > 0) {
                    var stylesFormatted = wc.styles.map(function(s) {
                        return s.replace(/_/g, ' ');
                    }).join(', ');
                    html += '<div class="entity-row"><span class="entity-label">Style:</span> ' + stylesFormatted + '</div>';
                }

                // Associated artifact
                if (data.artifact) {
                    html += '<div class="entity-row"><span class="entity-label">Artifact:</span> ' + renderArtifactLink(data.artifact.id, data.artifact.name, data.artifact.item_type) + '</div>';
                }

                // References
                if (data.references && data.references.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">References (' + data.references.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="10">';

                    data.references.forEach(function(ref, idx) {
                        var hiddenClass = idx >= 10 ? ' hidden-item' : '';
                        var refName = ref.name ? titleCase(ref.name) : (ref.type.replace(/_/g, ' ') + ' #' + ref.id);
                        var sprite = '';
                        var linkType = ref.entity_type || 'figure';

                        if (ref.entity_type === 'figure' && ref.race_img) {
                            sprite = '<img src="' + ref.race_img + '" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
                        } else if (ref.entity_type === 'site' && ref.site_type) {
                            sprite = '<img src="/static/icons/sites/' + ref.site_type.replace(/ /g, '_') + '.png" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
                        } else if (ref.entity_type === 'artifact' && ref.item_type) {
                            sprite = '<img src="/static/icons/artifacts/' + ref.item_type + '.png" class="inline-icon" alt="" onerror="this.style.display=\'none\'">';
                        }

                        var refTypeLabel = ref.type.replace(/_/g, ' ').replace('historical figure', 'figure');
                        html += '<div class="entity-list-item' + hiddenClass + '"><span class="link-type">' + refTypeLabel + ':</span> ' + sprite + '<a href="#" class="entity-link" data-type="' + linkType + '" data-id="' + ref.id + '">' + refName + '</a></div>';
                    });

                    if (data.references.length > 10) {
                        html += '<div class="expand-more-btn" data-count="' + (data.references.length - 10) + '">... and ' + (data.references.length - 10) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                html += '</div>';
                html += '<div class="modal-footer"><a href="/written?q=' + encodeURIComponent(wc.title || '') + '" class="btn btn-sm">View in List</a></div>';
                return html;
            }
        };

        function load(type, id) {
            var endpoints = {
                figure: '/api/figure/',
                site: '/api/site/',
                artifact: '/api/artifact/',
                entity: '/api/entity/',
                written: '/api/written/'
            };

            var endpoint = endpoints[type];
            if (!endpoint) {
                setError('Unknown entity type');
                return;
            }

            show('Loading...');

            fetch(endpoint + id)
                .then(function(r) {
                    if (!r.ok) throw new Error('Not found');
                    return r.json();
                })
                .then(function(data) {
                    var name = data[type] ? (data[type].name || 'ID: ' + id) : 'ID: ' + id;
                    var titleHtml = getTitleWithSprite(type, data);
                    modalTitle.innerHTML = titleHtml || titleCase(name);
                    var renderer = renderers[type];
                    if (renderer) {
                        setContent(renderer(data));
                    } else {
                        setContent('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
                    }

                    // Add to history
                    if (type === 'figure' && data.figure) {
                        addToHistory('figure', id, data.figure.name, data.figure.race, null, data.figure.race_img);
                    } else if (type === 'site' && data.site) {
                        addToHistory('site', id, data.site.name, null, data.site.type, null);
                    } else if (type === 'artifact' && data.artifact) {
                        addToHistory('artifact', id, data.artifact.name, null, null, null);
                    } else if (type === 'entity' && data.entity) {
                        addToHistory('entity', id, data.entity.name, null, null, null);
                    } else if (type === 'written' && data.written) {
                        addToHistory('written', id, data.written.title, null, null, null);
                    }
                })
                .catch(function(err) {
                    setError('Could not load ' + type + ' #' + id);
                });
        }

        // Event listeners
        closeBtn.addEventListener('click', hide);
        modal.addEventListener('click', function(e) {
            if (e.target === modal) hide();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display !== 'none') hide();
        });

        // Delegate clicks on entity links within modal
        modalContent.addEventListener('click', function(e) {
            var link = e.target.closest('.entity-link');
            if (link) {
                e.preventDefault();
                load(link.dataset.type, link.dataset.id);
                return;
            }
            // Handle expand more button
            var expandBtn = e.target.closest('.expand-more-btn');
            if (expandBtn) {
                var list = expandBtn.closest('.expandable-list');
                if (list) {
                    list.querySelectorAll('.hidden-item').forEach(function(item) {
                        item.classList.remove('hidden-item');
                    });
                    expandBtn.remove();
                }
                return;
            }
            // Handle "View on Map" button for sites
            var mapBtn = e.target.closest('.site-map-btn');
            if (mapBtn) {
                e.preventDefault();
                var coords = mapBtn.dataset.coords;
                var siteId = mapBtn.dataset.siteId;
                if (coords) {
                    // Navigate to map with site coordinates in hash
                    window.location.href = '/map#site=' + siteId + '&coords=' + coords;
                }
            }
        });

        // Global click handler for entity links anywhere on page
        document.addEventListener('click', function(e) {
            var link = e.target.closest('.entity-link');
            if (link && !modalContent.contains(link)) {
                e.preventDefault();
                load(link.dataset.type, link.dataset.id);
            }
        });

        return { show: show, hide: hide, load: load, setContent: setContent };
    })();
    </script>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <span class="footer-logo">DF Tales</span>
                <span class="footer-tagline">Dwarf Fortress Legends Viewer</span>
            </div>
            <div class="footer-links">
                <a href="https://github.com/inpvlsa/df-world" target="_blank" rel="noopener">GitHub</a>
                <span class="footer-sep">|</span>
                <a href="https://ko-fi.com/inpvlsa" target="_blank" rel="noopener">Support</a>
            </div>
            <div class="footer-deco">
                <span class="deco-char">&#9617;</span>
                <span class="deco-char">&#9618;</span>
                <span class="deco-char">&#9619;</span>
                <span class="deco-char">&#9608;</span>
                <span class="deco-text">Strike the Earth!</span>
                <span class="deco-char">&#9608;</span>
                <span class="deco-char">&#9619;</span>
                <span class="deco-char">&#9618;</span>
                <span class="deco-char">&#9617;</span>
            </div>
        </div>
    </footer>
</body>
</html>
