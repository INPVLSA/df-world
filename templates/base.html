<!DOCTYPE html>
<html lang="en">
{% macro pagination(page, total_pages, base_url) %}
<div class="pagination">
    {# First and Previous #}
    {% if page > 1 %}
    <a href="{{ base_url }}&page=1" class="page-btn" title="First">&laquo;</a>
    <a href="{{ base_url }}&page={{ page - 1 }}" class="page-btn" title="Previous">&lsaquo;</a>
    {% else %}
    <span class="page-btn disabled">&laquo;</span>
    <span class="page-btn disabled">&lsaquo;</span>
    {% endif %}

    {# Page numbers #}
    {% set start_page = [page - 2, 1]|max %}
    {% set end_page = [page + 2, total_pages]|min %}

    {% if start_page > 1 %}
    <a href="{{ base_url }}&page=1" class="page-num">1</a>
    {% if start_page > 2 %}<span class="page-ellipsis">...</span>{% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
    {% if p == page %}
    <span class="page-num active">{{ p }}</span>
    {% else %}
    <a href="{{ base_url }}&page={{ p }}" class="page-num">{{ p }}</a>
    {% endif %}
    {% endfor %}

    {% if end_page < total_pages %}
    {% if end_page < total_pages - 1 %}<span class="page-ellipsis">...</span>{% endif %}
    <a href="{{ base_url }}&page={{ total_pages }}" class="page-num">{{ total_pages }}</a>
    {% endif %}

    {# Next and Last #}
    {% if page < total_pages %}
    <a href="{{ base_url }}&page={{ page + 1 }}" class="page-btn" title="Next">&rsaquo;</a>
    <a href="{{ base_url }}&page={{ total_pages }}" class="page-btn" title="Last">&raquo;</a>
    {% else %}
    <span class="page-btn disabled">&rsaquo;</span>
    <span class="page-btn disabled">&raquo;</span>
    {% endif %}
</div>
{% endmacro %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DF-World{% endblock %}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='ico.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='ico.png') }}" alt="" class="nav-icon nav-logo" width="23" height="20">DF-World</a>
            </div>
            <div class="nav-links">
                <a href="{{ url_for('figures') }}"><img src="{{ url_for('static', filename='icons/races/DWARF.png') }}" alt="" class="nav-icon">Figures</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('sites') }}"><img src="{{ url_for('static', filename='icons/sites/fortress.png') }}" alt="" class="nav-icon">Sites</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('artifacts') }}"><img src="{{ url_for('static', filename='icons/artifact.png') }}" alt="" class="nav-icon">Artifacts</a>
                <span class="nav-sep"></span>
                <a href="{{ url_for('world_map') }}" class="nav-hidden"><span class="nav-icon-text">&#9635;</span>Map</a>
                <span class="nav-sep nav-hidden"></span>
                <a href="{{ url_for('events') }}"><img src="{{ url_for('static', filename='icons/scribe.png') }}" alt="" class="nav-icon">Events</a>
            </div>
        </div>
    </nav>

    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- Entity Modal -->
    <div id="entity-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title"></span>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-loading">Loading...</div>
                <div class="modal-content"></div>
            </div>
        </div>
    </div>

    <script>
    // Global Entity Modal System
    window.EntityModal = (function() {
        var modal = document.getElementById('entity-modal');
        var modalTitle = modal.querySelector('.modal-title');
        var modalContent = modal.querySelector('.modal-content');
        var modalLoading = modal.querySelector('.modal-loading');
        var closeBtn = modal.querySelector('.modal-close');

        function titleCase(str) {
            if (!str) return '-';
            return str.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
        }

        function formatLinkType(linkType) {
            if (!linkType) return '';
            return linkType.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
        }

        function formatEntityFallback(entity) {
            // When entity has no name, show type + race as fallback
            var parts = [];
            if (entity.entity_race) {
                parts.push(titleCase(entity.entity_race.replace(/_/g, ' ')));
            }
            if (entity.entity_type) {
                parts.push(titleCase(entity.entity_type.replace(/_/g, ' ')));
            }
            if (parts.length > 0) {
                return parts.join(' ') + ' #' + entity.entity_id;
            }
            return 'Entity #' + entity.entity_id;
        }

        function formatEventDescription(ev, figId) {
            var parts = [];
            var extra = {};
            if (ev.extra_data) {
                try { extra = JSON.parse(ev.extra_data); } catch(e) {}
            }

            var type = (ev.type || '').replace(/ /g, '_');

            // Site reference
            if (ev.site_name) {
                parts.push('at <a href="#" class="entity-link" data-type="site" data-id="' + ev.site_id + '">' + titleCase(ev.site_name) + '</a>');
            }

            // Death events
            if (type === 'hist_figure_died') {
                if (ev.slayer_name) {
                    parts.unshift('killed by <a href="#" class="entity-link" data-type="figure" data-id="' + ev.slayer_hfid + '">' + titleCase(ev.slayer_name) + '</a>');
                }
                var cause = ev.death_cause || extra.death_cause;
                if (cause) {
                    parts.push('(' + cause.replace(/_/g, ' ') + ')');
                }
            }

            // Relationship events
            if (type === 'add_hf_hf_link' || type === 'remove_hf_hf_link') {
                if (ev.hfid2_name) {
                    var rel = extra.link_type ? extra.link_type.replace(/_/g, ' ') : 'relationship';
                    var verb = type === 'add_hf_hf_link' ? 'formed' : 'ended';
                    parts.unshift(verb + ' ' + rel + ' with <a href="#" class="entity-link" data-type="figure" data-id="' + ev.hfid2 + '">' + titleCase(ev.hfid2_name) + '</a>');
                }
            }

            // Entity link events
            if (type === 'add_hf_entity_link' || type === 'remove_hf_entity_link') {
                var linkType = extra.link_type || '';
                var entityId = ev.civ_id || ev.entity_id || extra.civ_id || extra.entity_id;
                if (entityId) {
                    parts.unshift('<a href="#" class="entity-link" data-type="entity" data-id="' + entityId + '">Entity #' + entityId + '</a>');
                }
                if (linkType) {
                    parts.unshift(linkType.replace(/_/g, ' '));
                }
            }

            // State change
            if (type === 'change_hf_state') {
                var state = ev.state || extra.state;
                if (state) {
                    parts.unshift('became ' + state.replace(/_/g, ' '));
                }
            }

            // Job change
            if (type === 'change_hf_job') {
                var newJob = extra.new_job;
                if (newJob) {
                    parts.unshift('became ' + newJob.replace(/_/g, ' '));
                }
            }

            // Artifact created
            if (type === 'artifact_created') {
                var artifactId = ev.artifact_id || extra.artifact_id;
                if (artifactId) {
                    parts.unshift('created <a href="#" class="entity-link" data-type="artifact" data-id="' + artifactId + '">artifact #' + artifactId + '</a>');
                }
            }

            return parts.join(' ');
        }

        function getTitleWithSprite(type, data) {
            var name, sprite = '';
            if (type === 'figure' && data.figure) {
                name = data.figure.name;
                var race = data.figure.race;
                if (race) {
                    var imgPath = '/static/icons/races/' + race + '.png';
                    sprite = '<img src="' + imgPath + '" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            } else if (type === 'site' && data.site) {
                name = data.site.name;
                var siteType = data.site.type;
                if (siteType) {
                    var imgPath = '/static/icons/sites/' + siteType.replace(/ /g, '_') + '.png';
                    sprite = '<img src="' + imgPath + '" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            } else if (type === 'artifact' && data.artifact) {
                name = data.artifact.name;
                sprite = '<img src="/static/icons/artifact.png" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
            } else if (type === 'entity' && data.entity) {
                name = data.entity.name;
                var race = data.entity.race;
                if (race) {
                    var imgPath = '/static/icons/races/' + race.toUpperCase() + '.png';
                    sprite = '<img src="' + imgPath + '" class="modal-title-icon" alt="" onerror="this.style.display=\'none\'">';
                }
            }
            if (name) {
                return sprite + titleCase(name);
            }
            return null;
        }

        function show(title) {
            modalTitle.textContent = title;
            modalContent.innerHTML = '';
            modalLoading.style.display = 'block';
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function hide() {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        function setContent(html) {
            modalLoading.style.display = 'none';
            modalContent.innerHTML = html;
        }

        function setError(msg) {
            modalLoading.style.display = 'none';
            modalContent.innerHTML = '<div class="modal-error">' + msg + '</div>';
        }

        // Renderers for each entity type
        var renderers = {
            figure: function(data) {
                var fig = data.figure;
                var html = '<div class="entity-details">';
                html += '<div class="entity-row"><span class="entity-label">Race:</span> ' + (fig.race_label || '-') + '</div>';
                html += '<div class="entity-row"><span class="entity-label">Caste:</span> ' + (fig.caste || '-') + '</div>';
                html += '<div class="entity-row"><span class="entity-label">Born:</span> ' + (fig.birth_year != null ? fig.birth_year : '-') + '</div>';
                html += '<div class="entity-row"><span class="entity-label">Died:</span> ' + (fig.death_year == -1 ? '<span class="alive">Alive</span>' : (fig.death_year || '-')) + '</div>';
                if (fig.birth_year != null && fig.age != null) {
                    html += '<div class="entity-row"><span class="entity-label">Age:</span> ' + fig.age + '</div>';
                }

                // Affiliations
                if (data.affiliations && data.affiliations.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Affiliations (' + data.affiliations.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="5">';
                    data.affiliations.forEach(function(aff, idx) {
                        var name = aff.entity_name ? titleCase(aff.entity_name) : formatEntityFallback(aff);
                        var linkType = formatLinkType(aff.link_type);
                        var hiddenClass = idx >= 5 ? ' hidden-item' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '"><span class="link-type">' + linkType + '</span>: ';
                        html += '<a href="#" class="entity-link" data-type="entity" data-id="' + aff.entity_id + '">' + name + '</a></div>';
                    });
                    if (data.affiliations.length > 5) {
                        html += '<div class="expand-more-btn" data-count="' + (data.affiliations.length - 5) + '">... and ' + (data.affiliations.length - 5) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Site links
                if (data.site_links && data.site_links.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Site Links (' + data.site_links.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="5">';
                    data.site_links.forEach(function(sl, idx) {
                        var name = sl.site_name ? titleCase(sl.site_name) : 'Site #' + sl.site_id;
                        var linkType = formatLinkType(sl.link_type);
                        var hiddenClass = idx >= 5 ? ' hidden-item' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '"><span class="link-type">' + linkType + '</span>: ';
                        html += '<a href="#" class="entity-link" data-type="site" data-id="' + sl.site_id + '">' + name + '</a></div>';
                    });
                    if (data.site_links.length > 5) {
                        html += '<div class="expand-more-btn" data-count="' + (data.site_links.length - 5) + '">... and ' + (data.site_links.length - 5) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                // Life events / history
                if (data.events && data.events.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Life Events (' + data.events.length + (data.events.length >= 100 ? '+' : '') + ')</div>';
                    html += '<div class="timeline">';
                    var lastYear = null;
                    data.events.forEach(function(ev) {
                        var yearChanged = ev.year !== lastYear;
                        if (yearChanged) {
                            html += '<div class="timeline-year">' + (ev.year || '?') + '</div>';
                            lastYear = ev.year;
                        }
                        html += '<div class="timeline-event">';
                        html += '<span class="timeline-type">' + (ev.type_label || ev.type || 'Event') + '</span>';
                        // Build description
                        var desc = formatEventDescription(ev, fig.id);
                        if (desc) {
                            html += '<span class="timeline-desc">' + desc + '</span>';
                        }
                        html += '</div>';
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                html += '<div class="modal-footer"><a href="/figures?q=' + encodeURIComponent(fig.name || '') + '" class="btn btn-sm">View in List</a></div>';
                return html;
            },

            site: function(data) {
                var site = data.site;
                var html = '<div class="entity-details">';
                html += '<div class="entity-row"><span class="entity-label">Type:</span> ' + (site.type_label || site.type || '-') + '</div>';
                html += '<div class="entity-row"><span class="entity-label">Coords:</span> ' + (site.coords || '-') + '</div>';
                if (site.civ_name) {
                    html += '<div class="entity-row"><span class="entity-label">Civilization:</span> ';
                    html += '<a href="#" class="entity-link" data-type="entity" data-id="' + site.civ_id + '">' + titleCase(site.civ_name) + '</a></div>';
                }

                // Structures
                if (data.structures && data.structures.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Structures (' + data.structures.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="10">';
                    data.structures.forEach(function(st, idx) {
                        var hiddenClass = idx >= 10 ? ' hidden-item' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '">' + (st.type_label || st.type || 'Structure') + ': ' + titleCase(st.name) + '</div>';
                    });
                    if (data.structures.length > 10) {
                        html += '<div class="expand-more-btn" data-count="' + (data.structures.length - 10) + '">... and ' + (data.structures.length - 10) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                html += '</div>';
                html += '<div class="modal-footer"><a href="/sites?q=' + encodeURIComponent(site.name || '') + '" class="btn btn-sm">View in List</a></div>';
                return html;
            },

            artifact: function(data) {
                var art = data.artifact;
                var html = '<div class="entity-details">';
                html += '<div class="entity-row"><span class="entity-label">Type:</span> ' + (art.item_type ? art.item_type.replace(/_/g, ' ') : '-') + '</div>';
                if (art.item_subtype) {
                    html += '<div class="entity-row"><span class="entity-label">Subtype:</span> ' + art.item_subtype.replace(/_/g, ' ') + '</div>';
                }
                html += '<div class="entity-row"><span class="entity-label">Material:</span> ' + (art.mat ? art.mat.replace(/_/g, ' ') : '-') + '</div>';

                if (art.creator_name) {
                    html += '<div class="entity-row"><span class="entity-label">Creator:</span> ';
                    html += '<a href="#" class="entity-link" data-type="figure" data-id="' + art.creator_hfid + '">' + titleCase(art.creator_name) + '</a></div>';
                }
                if (art.site_name) {
                    html += '<div class="entity-row"><span class="entity-label">Created at:</span> ';
                    html += '<a href="#" class="entity-link" data-type="site" data-id="' + art.site_id + '">' + titleCase(art.site_name) + '</a></div>';
                }
                if (art.holder_name) {
                    html += '<div class="entity-row"><span class="entity-label">Held by:</span> ';
                    html += '<a href="#" class="entity-link" data-type="figure" data-id="' + art.holder_hfid + '">' + titleCase(art.holder_name) + '</a></div>';
                }

                html += '</div>';
                html += '<div class="modal-footer"><a href="/artifacts?q=' + encodeURIComponent(art.name || '') + '" class="btn btn-sm">View in List</a></div>';
                return html;
            },

            entity: function(data) {
                var ent = data.entity;
                var html = '<div class="entity-details">';
                html += '<div class="entity-row"><span class="entity-label">Type:</span> ' + (ent.type || '-') + '</div>';
                html += '<div class="entity-row"><span class="entity-label">Race:</span> ' + (ent.race_label || ent.race || '-') + '</div>';

                // Positions
                if (data.positions && data.positions.length > 0) {
                    html += '<div class="entity-section"><div class="entity-section-title">Positions (' + data.positions.length + ')</div>';
                    html += '<div class="expandable-list" data-limit="10">';
                    data.positions.forEach(function(pos, idx) {
                        var holder = pos.holder_name ? ' - <a href="#" class="entity-link" data-type="figure" data-id="' + pos.histfig_id + '">' + titleCase(pos.holder_name) + '</a>' : '';
                        var hiddenClass = idx >= 10 ? ' hidden-item' : '';
                        html += '<div class="entity-list-item' + hiddenClass + '">' + titleCase(pos.name) + holder + '</div>';
                    });
                    if (data.positions.length > 10) {
                        html += '<div class="expand-more-btn" data-count="' + (data.positions.length - 10) + '">... and ' + (data.positions.length - 10) + ' more</div>';
                    }
                    html += '</div></div>';
                }

                html += '</div>';
                return html;
            }
        };

        function load(type, id) {
            var endpoints = {
                figure: '/api/figure/',
                site: '/api/site/',
                artifact: '/api/artifact/',
                entity: '/api/entity/'
            };

            var endpoint = endpoints[type];
            if (!endpoint) {
                setError('Unknown entity type');
                return;
            }

            show('Loading...');

            fetch(endpoint + id)
                .then(function(r) {
                    if (!r.ok) throw new Error('Not found');
                    return r.json();
                })
                .then(function(data) {
                    var name = data[type] ? (data[type].name || 'ID: ' + id) : 'ID: ' + id;
                    var titleHtml = getTitleWithSprite(type, data);
                    modalTitle.innerHTML = titleHtml || titleCase(name);
                    var renderer = renderers[type];
                    if (renderer) {
                        setContent(renderer(data));
                    } else {
                        setContent('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
                    }
                })
                .catch(function(err) {
                    setError('Could not load ' + type + ' #' + id);
                });
        }

        // Event listeners
        closeBtn.addEventListener('click', hide);
        modal.addEventListener('click', function(e) {
            if (e.target === modal) hide();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display !== 'none') hide();
        });

        // Delegate clicks on entity links within modal
        modalContent.addEventListener('click', function(e) {
            var link = e.target.closest('.entity-link');
            if (link) {
                e.preventDefault();
                load(link.dataset.type, link.dataset.id);
                return;
            }
            // Handle expand more button
            var expandBtn = e.target.closest('.expand-more-btn');
            if (expandBtn) {
                var list = expandBtn.closest('.expandable-list');
                if (list) {
                    list.querySelectorAll('.hidden-item').forEach(function(item) {
                        item.classList.remove('hidden-item');
                    });
                    expandBtn.remove();
                }
            }
        });

        // Global click handler for entity links anywhere on page
        document.addEventListener('click', function(e) {
            var link = e.target.closest('.entity-link');
            if (link && !modalContent.contains(link)) {
                e.preventDefault();
                load(link.dataset.type, link.dataset.id);
            }
        });

        return { show: show, hide: hide, load: load, setContent: setContent };
    })();
    </script>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <span class="footer-logo">DF-World</span>
                <span class="footer-tagline">Dwarf Fortress Legends Viewer</span>
            </div>
            <div class="footer-links">
                <a href="https://github.com/inpvlsa/df-world" target="_blank" rel="noopener">GitHub</a>
                <span class="footer-sep">|</span>
                <a href="https://ko-fi.com/inpvlsa" target="_blank" rel="noopener">Support</a>
            </div>
            <div class="footer-deco">
                <span class="deco-char">&#9617;</span>
                <span class="deco-char">&#9618;</span>
                <span class="deco-char">&#9619;</span>
                <span class="deco-char">&#9608;</span>
                <span class="deco-text">Strike the Earth!</span>
                <span class="deco-char">&#9608;</span>
                <span class="deco-char">&#9619;</span>
                <span class="deco-char">&#9618;</span>
                <span class="deco-char">&#9617;</span>
            </div>
        </div>
    </footer>
</body>
</html>
