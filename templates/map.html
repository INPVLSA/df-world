{% extends "base.html" %}

{% block title %}World Map - DF Tales{% endblock %}

{% block content %}
<h1>{% if world and world.has_plus and world.name %}{{ world.name|title }} Map{% else %}World Map{% endif %}</h1>

<div class="map-container">
    <div class="map-controls">
        <button id="zoom-in" class="map-btn" title="Zoom In">+</button>
        <button id="zoom-out" class="map-btn" title="Zoom Out">-</button>
        <button id="zoom-reset" class="map-btn" title="Reset">R</button>
        <button id="legend-toggle" class="map-btn active" title="Toggle Legend">&#9776;</button>
        <div class="map-search-wrapper">
            <input type="text" id="map-search" class="map-search-input" placeholder="Search sites...">
            <div class="map-search-results" id="map-search-results"></div>
        </div>
        <span class="map-info">{{ total_sites }} sites, {{ total_peaks }} peaks</span>
    </div>

    <div class="map-legend-dropdown open" id="map-legend">
        <div class="legend-tabs">
            <button class="legend-tab active" data-tab="sites">Sites</button>
            <button class="legend-tab" data-tab="peaks">Peaks</button>
        </div>

        <div class="legend-tab-content" id="tab-sites">
            <div class="legend-items">
                {% for tc in type_counts %}
                {% set ti = get_site_type_info(tc.type) %}
                <label class="legend-item">
                    <input type="checkbox" checked data-type="{{ tc.type|replace(' ', '-') }}" class="legend-toggle site-toggle">
                    {% if ti.img %}
                    <img src="{{ ti.img }}" alt="{{ ti.icon }}" class="legend-icon">
                    {% else %}
                    <span class="legend-icon-text">{{ ti.icon }}</span>
                    {% endif %}
                    <span class="legend-label">{{ ti.label }}</span>
                    <span class="legend-count">({{ tc.count }})</span>
                </label>
                {% endfor %}
            </div>
            <div class="legend-actions">
                <button id="legend-all-sites" class="legend-btn">All</button>
                <button id="legend-none-sites" class="legend-btn">None</button>
            </div>
        </div>

        <div class="legend-tab-content" id="tab-peaks" style="display: none;">
            <div class="legend-items">
                <label class="legend-item">
                    <input type="checkbox" checked data-type="peak" class="legend-toggle peak-toggle">
                    <span class="legend-icon-text">&#9650;</span>
                    <span class="legend-label">Mountain Peaks</span>
                    <span class="legend-count">({{ total_peaks }})</span>
                </label>
                <label class="legend-item">
                    <input type="checkbox" checked data-type="volcano" class="legend-toggle peak-toggle">
                    <span class="legend-icon-text" style="color: #ff4500;">&#9650;</span>
                    <span class="legend-label">Volcanoes</span>
                    <span class="legend-count">({{ peaks|selectattr('is_volcano')|list|length }})</span>
                </label>
            </div>
            <div class="legend-peaks-list">
                {% for peak in peaks %}
                <div class="legend-peak-item" data-peak-id="{{ peak.id }}" data-x="{{ peak.x }}" data-y="{{ peak.y }}">
                    <span class="peak-icon{% if peak.is_volcano %} volcano{% endif %}">&#9650;</span>
                    <span class="peak-name">{{ peak.name }}</span>
                    <span class="peak-height">{{ peak.height }}m</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="map-viewport" id="map-viewport" style="aspect-ratio: {{ map_width }} / {{ map_height }};">
        <div class="map-canvas{% if has_map %} has-bg{% endif %}" id="map-canvas"
             {% if has_map %}style="background-image: url('{{ url_for('world_map_image', world_id=world_id) }}');"{% endif %}>
            {% for site in sites %}
            <div class="map-marker site-marker type-{{ site.type|replace(' ', '-') }}"
                 data-id="{{ site.id }}"
                 data-name="{{ site.name }}"
                 data-type="{{ site.type_label }}"
                 data-civ="{{ site.civ_label or '' }}"
                 style="left: {{ ((site.x - min_x + 0.5) / map_width * 100) }}%; top: {{ ((site.y - min_y + 0.5) / map_height * 100) }}%;"
                 title="{{ site.name }}">
                {% if site.type_img %}
                <img src="{{ site.type_img }}" alt="{{ site.type_icon }}" class="marker-icon">
                {% else %}
                <span class="marker-text">{{ site.type_icon }}</span>
                {% endif %}
            </div>
            {% endfor %}

            {% for peak in peaks %}
            <div class="map-marker peak-marker{% if peak.is_volcano %} volcano{% endif %}"
                 data-id="{{ peak.id }}"
                 data-name="{{ peak.name }}"
                 data-height="{{ peak.height }}"
                 data-volcano="{{ peak.is_volcano }}"
                 style="left: {{ ((peak.x - min_x + 0.5) / map_width * 100) }}%; top: {{ ((peak.y - min_y + 0.5) / map_height * 100) }}%;"
                 title="{{ peak.name }}">
                <span class="marker-text peak-icon">&#9650;</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="map-tooltip" id="map-tooltip"></div>
</div>

<script>
(function() {
    var viewport = document.getElementById('map-viewport');
    var canvas = document.getElementById('map-canvas');
    var tooltip = document.getElementById('map-tooltip');
    var siteMarkers = document.querySelectorAll('.site-marker');
    var peakMarkers = document.querySelectorAll('.peak-marker');
    var legend = document.getElementById('map-legend');
    var legendToggle = document.getElementById('legend-toggle');

    var scale = 1;
    var minScale = 0.5;
    var maxScale = 5;
    var panX = 0, panY = 0;
    var isDragging = false;
    var startX, startY, startPanX, startPanY;

    // Search elements
    var searchInput = document.getElementById('map-search');
    var searchResults = document.getElementById('map-search-results');
    var searchTimeout = null;

    // Map bounds for coordinate calculation
    var minX = {{ min_x }};
    var minY = {{ min_y }};
    var mapWidth = {{ map_width }};
    var mapHeight = {{ map_height }};

    function updateTransform() {
        canvas.style.transform = 'translate(' + panX + 'px, ' + panY + 'px) scale(' + scale + ')';
    }

    // Navigate to coordinates
    function navigateTo(xPercent, yPercent) {
        var viewportRect = viewport.getBoundingClientRect();

        // Set zoom level first
        scale = Math.min(maxScale, 3);

        // Point position relative to canvas center (since transform-origin is center)
        var pointX = (xPercent / 100 - 0.5) * canvas.offsetWidth;
        var pointY = (yPercent / 100 - 0.5) * canvas.offsetHeight;

        // Pan so that point is at viewport center
        panX = -pointX * scale;
        panY = -pointY * scale;

        updateTransform();
    }

    // Legend dropdown toggle
    legendToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        legend.classList.toggle('open');
        legendToggle.classList.toggle('active');
    });

    // Close legend when clicking outside
    document.addEventListener('click', function(e) {
        if (window.innerWidth < 1024 && !legend.contains(e.target) && e.target !== legendToggle) {
            legend.classList.remove('open');
            legendToggle.classList.remove('active');
        }

        // Close search results when clicking outside
        if (window.innerWidth < 1024 && !searchResults.contains(e.target) && e.target !== searchInput) {
            searchResults.classList.remove('open');
        }
    });

    // Site search functionality
    function titleCase(str) {
        if (!str) return '(unnamed)';
        return str.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    }

    function performSearch(query) {
        if (query.length < 2) {
            searchResults.classList.remove('open');
            return;
        }

        fetch('/map/search?q=' + encodeURIComponent(query))
            .then(function(r) { return r.json(); })
            .then(function(results) {
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="map-search-empty">No sites found</div>';
                } else {
                    var html = '';
                    results.forEach(function(site) {
                        var icon = site.type_img
                            ? '<img src="' + site.type_img + '" alt="">'
                            : '<span class="result-icon">' + site.type_icon + '</span>';
                        html += '<div class="map-search-result" data-x="' + site.x + '" data-y="' + site.y + '" data-id="' + site.id + '">' +
                            icon +
                            '<span class="result-name">' + titleCase(site.name) + '</span>' +
                            '<span class="result-type">' + site.type + '</span>' +
                            '</div>';
                    });
                    searchResults.innerHTML = html;
                }
                searchResults.classList.add('open');
            });
    }

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            performSearch(searchInput.value.trim());
        }, 200);
    });

    searchInput.addEventListener('focus', function() {
        if (searchInput.value.trim().length >= 2) {
            performSearch(searchInput.value.trim());
        }
    });

    searchResults.addEventListener('click', function(e) {
        var result = e.target.closest('.map-search-result');
        if (result) {
            var x = parseFloat(result.dataset.x);
            var y = parseFloat(result.dataset.y);
            var xPercent = ((x - minX + 0.5) / mapWidth) * 100;
            var yPercent = ((y - minY + 0.5) / mapHeight) * 100;

            navigateTo(xPercent, yPercent);
            searchResults.classList.remove('open');
            searchInput.value = '';

            // Highlight the site marker briefly
            var siteId = result.dataset.id;
            var marker = document.querySelector('.site-marker[data-id="' + siteId + '"]');
            if (marker) {
                marker.classList.add('highlight');
                setTimeout(function() { marker.classList.remove('highlight'); }, 2000);
            }
        }
    });

    // Tab switching
    document.querySelectorAll('.legend-tab').forEach(function(tab) {
        tab.addEventListener('click', function(e) {
            e.stopPropagation();
            document.querySelectorAll('.legend-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.legend-tab-content').forEach(function(c) { c.style.display = 'none'; });
            tab.classList.add('active');
            document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
        });
    });

    // Zoom controls
    document.getElementById('zoom-in').addEventListener('click', function() {
        scale = Math.min(maxScale, scale * 1.3);
        updateTransform();
    });

    document.getElementById('zoom-out').addEventListener('click', function() {
        scale = Math.max(minScale, scale / 1.3);
        updateTransform();
    });

    document.getElementById('zoom-reset').addEventListener('click', function() {
        scale = 1;
        panX = 0;
        panY = 0;
        updateTransform();
    });

    // Mouse wheel zoom - zoom toward cursor position
    viewport.addEventListener('wheel', function(e) {
        e.preventDefault();
        var rect = viewport.getBoundingClientRect();
        var mouseX = e.clientX - rect.left;
        var mouseY = e.clientY - rect.top;

        // Point on canvas under cursor (before zoom)
        var canvasCenterX = rect.width / 2;
        var canvasCenterY = rect.height / 2;
        var pointX = (mouseX - canvasCenterX - panX) / scale;
        var pointY = (mouseY - canvasCenterY - panY) / scale;

        var delta = e.deltaY > 0 ? 0.9 : 1.1;
        var newScale = Math.max(minScale, Math.min(maxScale, scale * delta));

        // Adjust pan so the same point stays under cursor
        panX = mouseX - canvasCenterX - pointX * newScale;
        panY = mouseY - canvasCenterY - pointY * newScale;

        scale = newScale;
        updateTransform();
    });

    // Pan with drag
    viewport.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('map-marker') || e.target.closest('.map-marker')) return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startPanX = panX;
        startPanY = panY;
        viewport.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        panX = startPanX + (e.clientX - startX);
        panY = startPanY + (e.clientY - startY);
        updateTransform();
    });

    document.addEventListener('mouseup', function() {
        isDragging = false;
        viewport.style.cursor = 'grab';
    });

    // Site marker tooltips
    siteMarkers.forEach(function(marker) {
        marker.addEventListener('mouseenter', function(e) {
            var name = marker.dataset.name || 'Unknown';
            var type = marker.dataset.type || '';
            var civ = marker.dataset.civ;

            var html = '<strong>' + name + '</strong><br>' + type;
            if (civ) html += '<br><span class="tooltip-civ">' + civ + '</span>';

            tooltip.innerHTML = html;
            tooltip.style.display = 'block';
        });

        marker.addEventListener('mousemove', function(e) {
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
        });

        marker.addEventListener('mouseleave', function() {
            tooltip.style.display = 'none';
        });

        marker.addEventListener('click', function() {
            var id = marker.dataset.id;
            if (typeof EntityModal !== 'undefined' && EntityModal.load) {
                EntityModal.load('site', id);
            } else {
                window.location.href = '/site/' + id;
            }
        });
    });

    // Peak marker tooltips
    peakMarkers.forEach(function(marker) {
        marker.addEventListener('mouseenter', function(e) {
            var name = marker.dataset.name || 'Unknown';
            var height = marker.dataset.height || '';
            var isVolcano = marker.dataset.volcano === '1';

            var html = '<strong>' + name + '</strong><br>';
            html += isVolcano ? '<span style="color:#ff4500;">Volcano</span>' : 'Mountain Peak';
            html += '<br>Height: ' + height + 'm';

            tooltip.innerHTML = html;
            tooltip.style.display = 'block';
        });

        marker.addEventListener('mousemove', function(e) {
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
        });

        marker.addEventListener('mouseleave', function() {
            tooltip.style.display = 'none';
        });

        marker.addEventListener('click', function() {
            var id = marker.dataset.id;
            window.location.href = '/peak/' + id;
        });
    });

    // Site visibility toggle
    function updateSiteVisibility() {
        document.querySelectorAll('.site-toggle').forEach(function(checkbox) {
            var type = checkbox.dataset.type;
            var visible = checkbox.checked;
            document.querySelectorAll('.site-marker.type-' + type).forEach(function(m) {
                m.style.display = visible ? '' : 'none';
            });
        });
    }

    // Peak visibility toggle
    function updatePeakVisibility() {
        var showPeaks = document.querySelector('.peak-toggle[data-type="peak"]').checked;
        var showVolcanoes = document.querySelector('.peak-toggle[data-type="volcano"]').checked;

        peakMarkers.forEach(function(m) {
            var isVolcano = m.dataset.volcano === '1';
            if (isVolcano) {
                m.style.display = showVolcanoes ? '' : 'none';
            } else {
                m.style.display = showPeaks ? '' : 'none';
            }
        });
    }

    document.querySelectorAll('.site-toggle').forEach(function(checkbox) {
        checkbox.addEventListener('change', updateSiteVisibility);
    });

    document.querySelectorAll('.peak-toggle').forEach(function(checkbox) {
        checkbox.addEventListener('change', updatePeakVisibility);
    });

    // All/None buttons for sites
    document.getElementById('legend-all-sites').addEventListener('click', function() {
        document.querySelectorAll('.site-toggle').forEach(function(cb) { cb.checked = true; });
        updateSiteVisibility();
    });

    document.getElementById('legend-none-sites').addEventListener('click', function() {
        document.querySelectorAll('.site-toggle').forEach(function(cb) { cb.checked = false; });
        updateSiteVisibility();
    });

    // Peak list navigation
    document.querySelectorAll('.legend-peak-item').forEach(function(item) {
        item.addEventListener('click', function(e) {
            e.stopPropagation();
            var x = parseFloat(item.dataset.x);
            var y = parseFloat(item.dataset.y);
            var minX = {{ min_x }};
            var minY = {{ min_y }};
            var mapWidth = {{ map_width }};
            var mapHeight = {{ map_height }};

            var xPercent = ((x - minX + 0.5) / mapWidth) * 100;
            var yPercent = ((y - minY + 0.5) / mapHeight) * 100;

            navigateTo(xPercent, yPercent);

            // Highlight the peak marker briefly
            var peakId = item.dataset.peakId;
            var marker = document.querySelector('.peak-marker[data-id="' + peakId + '"]');
            if (marker) {
                marker.classList.add('highlight');
                setTimeout(function() { marker.classList.remove('highlight'); }, 2000);
            }
        });
    });

    // Handle hash navigation from site modal "View on Map" button
    function handleHashNavigation() {
        var hash = window.location.hash;
        if (hash && hash.indexOf('site=') !== -1) {
            var params = {};
            hash.substring(1).split('&').forEach(function(part) {
                var kv = part.split('=');
                if (kv.length === 2) params[kv[0]] = kv[1];
            });

            if (params.coords) {
                var coords = params.coords.split(',');
                if (coords.length === 2) {
                    var x = parseInt(coords[0]);
                    var y = parseInt(coords[1]);
                    var xPercent = ((x - minX + 0.5) / mapWidth) * 100;
                    var yPercent = ((y - minY + 0.5) / mapHeight) * 100;

                    // Small delay to ensure page is ready
                    setTimeout(function() {
                        navigateTo(xPercent, yPercent);

                        // Highlight the site marker
                        if (params.site) {
                            var marker = document.querySelector('.site-marker[data-id="' + params.site + '"]');
                            if (marker) {
                                marker.classList.add('highlight');
                                setTimeout(function() { marker.classList.remove('highlight'); }, 2000);
                            }
                        }
                    }, 100);
                }
            }
            // Clear hash after navigation
            history.replaceState(null, '', window.location.pathname);
        }
    }

    // Run on page load
    handleHashNavigation();
})();
</script>
{% endblock %}
