{% extends "base.html" %}
{% from "base.html" import pagination with context %}

{% block title %}Historical Figures - DF-World{% endblock %}

{% block content %}
<h1>Historical Figures</h1>

<div class="filters">
    <input type="text" id="search-input" placeholder="Search by name..." value="{{ search }}">
    <select id="race-select">
        <option value="">All Races</option>
        {% for r in races %}
        <option value="{{ r.race }}" {% if race_filter == r.race %}selected{% endif %}>{{ r.race|race_label }}</option>
        {% endfor %}
    </select>
    <button type="button" id="clear-filters" class="btn btn-clear"{% if not search and not race_filter %} disabled{% endif %}>Clear</button>
</div>

<p class="results-info">Showing <span id="showing-count">{{ figures|length }}</span> of <span id="total-count">{{ "{:,}".format(total) }}</span> figures</p>

<table>
    <thead>
        <tr>
            <th class="expand-col"></th>
            <th class="sortable{% if sort == 'id' %} sorted {{ dir }}{% endif %}" data-sort="id">ID</th>
            <th class="sortable{% if sort == 'name' %} sorted {{ dir }}{% endif %}" data-sort="name">Name</th>
            <th class="sortable{% if sort == 'race' %} sorted {{ dir }}{% endif %}" data-sort="race">Race</th>
            <th class="sortable{% if sort == 'caste' %} sorted {{ dir }}{% endif %}" data-sort="caste">Caste</th>
            <th class="sortable{% if sort == 'birth_year' %} sorted {{ dir }}{% endif %}" data-sort="birth_year">Born</th>
            <th class="sortable{% if sort == 'death_year' %} sorted {{ dir }}{% endif %}" data-sort="death_year">Died</th>
            <th>Age</th>
        </tr>
    </thead>
    <tbody id="figures-tbody">
        {% for fig in figures %}
        <tr class="figure-row" data-figure-id="{{ fig.id }}" data-link-count="{{ fig.link_count or 0 }}">
            <td class="expand-toggle"><span class="expand-icon{% if not fig.link_count %} no-links{% endif %}">+</span></td>
            <td>{{ fig.id }}</td>
            <td>{{ fig.name|title if fig.name else '(unnamed)' }}</td>
            <td class="race-cell">{% set ri = get_race_info(fig.race) %}{% if ri.img %}<img src="{{ ri.img }}" class="race-icon" alt="">{% else %}<span class="race-icon-text">{{ ri.icon }}</span>{% endif %} {{ ri.label }}</td>
            <td>{{ fig.caste or '-' }}</td>
            <td>{{ fig.birth_year if fig.birth_year else '-' }}</td>
            <td>{% if fig.death_year == -1 %}<span class="alive">Alive</span>{% else %}{{ fig.death_year if fig.death_year else '-' }}{% endif %}</td>
            <td>{% if fig.birth_year and current_year %}{% if fig.death_year == -1 %}{{ current_year - fig.birth_year }}{% elif fig.death_year %}{{ fig.death_year - fig.birth_year }}{% else %}-{% endif %}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="pagination" id="pagination">
    {{ pagination(page, total_pages, '?q=' ~ search ~ '&race=' ~ race_filter ~ '&sort=' ~ sort ~ '&dir=' ~ dir) }}
</div>

<script>
(function() {
    var searchInput = document.getElementById('search-input');
    var raceSelect = document.getElementById('race-select');
    var clearBtn = document.getElementById('clear-filters');
    var tbody = document.getElementById('figures-tbody');
    var thead = document.querySelector('table thead');
    var showingCount = document.getElementById('showing-count');
    var totalCount = document.getElementById('total-count');
    var paginationContainer = document.getElementById('pagination');

    var timeout = null;
    var currentPage = {{ page }};
    var perPage = {{ per_page }};
    var currentSort = '{{ sort }}';
    var currentDir = '{{ dir }}';
    var expandedFigures = {};
    var hasPlus = {{ 'true' if has_plus else 'false' }};

    function formatNumber(n) {
        return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function titleCase(str) {
        if (!str) return '(unnamed)';
        return str.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    }

    function formatLinkType(linkType) {
        if (!linkType) return 'Member';
        return linkType.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    }

    var COLLAPSED_LIMIT = 5;
    var expandGroupId = 0;

    function renderFigureDetails(affiliations, siteLinks) {
        var hasAffiliations = affiliations && affiliations.length > 0;
        var hasSiteLinks = siteLinks && siteLinks.length > 0;

        if (!hasAffiliations && !hasSiteLinks) {
            return '<tr class="affiliations-row"><td colspan="8" class="affiliations-cell"><div class="affiliations-content"><em>No affiliations or site links</em></div></td></tr>';
        }

        var html = '<tr class="affiliations-row"><td colspan="8" class="affiliations-cell"><div class="affiliations-content">';

        // Check if any affiliation is missing entity name (no DFHack data)
        var missingNames = hasAffiliations && affiliations.some(function(aff) { return !aff.entity_name; });
        if (missingNames && !hasPlus) {
            html += '<div class="affiliations-note"><span class="missing-icon">!</span> Entity names require DFHack <code>legends_plus.xml</code>. <a href="/">Merge DFHack data</a> to see full details.</div>';
        }

        // Entity affiliations - grouped by link type
        if (hasAffiliations) {
            html += '<div class="details-section"><div class="details-header">Affiliations</div>';

            // Group by link_type
            var grouped = {};
            affiliations.forEach(function(aff) {
                var lt = aff.link_type || 'member';
                if (!grouped[lt]) grouped[lt] = [];
                grouped[lt].push(aff);
            });

            // Render each group
            Object.keys(grouped).forEach(function(linkType) {
                var items = grouped[linkType];
                var groupId = 'aff-group-' + (++expandGroupId);
                var linkTypeLabel = formatLinkType(linkType);

                html += '<div class="link-type-group"><span class="link-type-label">' + linkTypeLabel + ' (' + items.length + ')</span>';
                html += '<div class="affiliations-list">';

                items.forEach(function(aff, idx) {
                    var entityName = aff.entity_name ? titleCase(aff.entity_name) : 'Entity #' + aff.entity_id;
                    var entityType = aff.entity_type ? ' <span class="entity-type">(' + aff.entity_type + ')</span>' : '';
                    var hiddenClass = idx >= COLLAPSED_LIMIT ? ' hidden-item ' + groupId : '';
                    html += '<div class="affiliation-item' + hiddenClass + '">' + entityName + entityType + '</div>';
                });

                html += '</div>';

                if (items.length > COLLAPSED_LIMIT) {
                    var remaining = items.length - COLLAPSED_LIMIT;
                    html += '<a href="#" class="show-more-link" data-group="' + groupId + '" data-showing="collapsed">Show ' + remaining + ' more</a>';
                }

                html += '</div>';
            });

            html += '</div>';
        }

        // Site links - simple list (no grouping/collapsing since counts are low)
        if (hasSiteLinks) {
            html += '<div class="details-section"><div class="details-header">Site Links</div>';
            html += '<div class="affiliations-list">';
            siteLinks.forEach(function(sl) {
                var siteName = sl.site_name ? titleCase(sl.site_name) : 'Site #' + sl.site_id;
                var siteIcon = sl.site_type_img ? '<img src="' + sl.site_type_img + '" class="site-link-icon" alt="">' : '<span class="site-link-icon-text">' + sl.site_type_icon + '</span>';
                var linkType = formatLinkType(sl.link_type);
                html += '<div class="affiliation-item">' + siteIcon + ' <span class="link-type">' + linkType + '</span>: ' + siteName + '</div>';
            });
            html += '</div></div>';
        }

        html += '</div></td></tr>';
        return html;
    }

    function toggleAffiliations(figureRow) {
        var figureId = figureRow.dataset.figureId;
        var icon = figureRow.querySelector('.expand-icon');
        var nextRow = figureRow.nextElementSibling;

        if (nextRow && nextRow.classList.contains('affiliations-row')) {
            nextRow.remove();
            icon.textContent = '+';
            figureRow.classList.remove('expanded');
            delete expandedFigures[figureId];
        } else {
            icon.textContent = '-';
            figureRow.classList.add('expanded');

            figureRow.insertAdjacentHTML('afterend', '<tr class="affiliations-row"><td colspan="8" class="affiliations-cell"><div class="affiliations-content"><em>Loading...</em></div></td></tr>');
            fetch('/figures/' + figureId + '/affiliations')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    expandedFigures[figureId] = data;
                    var loadingRow = figureRow.nextElementSibling;
                    if (loadingRow && loadingRow.classList.contains('affiliations-row')) {
                        loadingRow.outerHTML = renderFigureDetails(data.affiliations, data.site_links);
                    }
                });
        }
    }

    function renderPagination(page, totalPages) {
        var html = '<div class="pagination">';

        // First and Previous
        if (page > 1) {
            html += '<a href="#" data-page="1" class="page-btn" title="First">&laquo;</a>';
            html += '<a href="#" data-page="' + (page - 1) + '" class="page-btn" title="Previous">&lsaquo;</a>';
        } else {
            html += '<span class="page-btn disabled">&laquo;</span>';
            html += '<span class="page-btn disabled">&lsaquo;</span>';
        }

        // Page numbers
        var startPage = Math.max(page - 2, 1);
        var endPage = Math.min(page + 2, totalPages);

        if (startPage > 1) {
            html += '<a href="#" data-page="1" class="page-num">1</a>';
            if (startPage > 2) html += '<span class="page-ellipsis">...</span>';
        }

        for (var p = startPage; p <= endPage; p++) {
            if (p === page) {
                html += '<span class="page-num active">' + p + '</span>';
            } else {
                html += '<a href="#" data-page="' + p + '" class="page-num">' + p + '</a>';
            }
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += '<span class="page-ellipsis">...</span>';
            html += '<a href="#" data-page="' + totalPages + '" class="page-num">' + totalPages + '</a>';
        }

        // Next and Last
        if (page < totalPages) {
            html += '<a href="#" data-page="' + (page + 1) + '" class="page-btn" title="Next">&rsaquo;</a>';
            html += '<a href="#" data-page="' + totalPages + '" class="page-btn" title="Last">&raquo;</a>';
        } else {
            html += '<span class="page-btn disabled">&rsaquo;</span>';
            html += '<span class="page-btn disabled">&raquo;</span>';
        }

        html += '</div>';
        return html;
    }

    function updateSortHeaders(sortCol, sortDir) {
        thead.querySelectorAll('th.sortable').forEach(function(th) {
            th.classList.remove('sorted', 'asc', 'desc');
            if (th.dataset.sort === sortCol) {
                th.classList.add('sorted', sortDir);
            }
        });
    }

    function fetchData(page, sort, dir) {
        var params = new URLSearchParams();
        params.set('page', page);
        if (searchInput.value) params.set('q', searchInput.value);
        if (raceSelect.value) params.set('race', raceSelect.value);
        params.set('sort', sort);
        params.set('dir', dir);

        // Update URL without reload
        history.replaceState(null, '', '?' + params.toString());

        fetch('/figures?' + params.toString(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            currentPage = data.page;
            currentSort = data.sort;
            currentDir = data.dir;
            expandedFigures = {};

            // Update table
            var html = '';
            data.figures.forEach(function(fig) {
                var noLinks = !fig.link_count ? ' no-links' : '';
                html += '<tr class="figure-row" data-figure-id="' + fig.id + '" data-link-count="' + (fig.link_count || 0) + '">' +
                    '<td class="expand-toggle"><span class="expand-icon' + noLinks + '">+</span></td>' +
                    '<td>' + fig.id + '</td>' +
                    '<td>' + titleCase(fig.name) + '</td>' +
                    '<td class="race-cell">' + (fig.race_img ? '<img src="' + fig.race_img + '" class="race-icon" alt="">' : '<span class="race-icon-text">' + fig.race_icon + '</span>') + ' ' + fig.race_label + '</td>' +
                    '<td>' + (fig.caste || '-') + '</td>' +
                    '<td>' + (fig.birth_year != null ? fig.birth_year : '-') + '</td>' +
                    '<td>' + (fig.death_year === -1 ? '<span class="alive">Alive</span>' : (fig.death_year != null ? fig.death_year : '-')) + '</td>' +
                    '<td>' + (fig.age != null ? fig.age : '-') + '</td>' +
                '</tr>';
            });
            tbody.innerHTML = html;

            // Update counts
            showingCount.textContent = data.figures.length;
            totalCount.textContent = formatNumber(data.total);

            // Update pagination
            paginationContainer.innerHTML = renderPagination(data.page, data.total_pages);

            // Update sort headers
            updateSortHeaders(data.sort, data.dir);
        });
    }

    searchInput.addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(function() {
            fetchData(1, currentSort, currentDir);
        }, 300);
    });

    raceSelect.addEventListener('change', function() {
        fetchData(1, currentSort, currentDir);
    });

    paginationContainer.addEventListener('click', function(e) {
        var target = e.target.closest('[data-page]');
        if (target) {
            e.preventDefault();
            fetchData(parseInt(target.dataset.page), currentSort, currentDir);
        }
    });

    thead.addEventListener('click', function(e) {
        var th = e.target.closest('th.sortable');
        if (th) {
            var col = th.dataset.sort;
            var newDir = 'asc';
            // If clicking the same column, toggle direction
            if (col === currentSort) {
                newDir = currentDir === 'asc' ? 'desc' : 'asc';
            }
            fetchData(1, col, newDir);
        }
    });

    function updateClearButton() {
        clearBtn.disabled = !searchInput.value && !raceSelect.value;
    }

    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        raceSelect.value = '';
        updateClearButton();
        fetchData(1, 'name', 'asc');
    });

    searchInput.addEventListener('input', updateClearButton);
    raceSelect.addEventListener('change', updateClearButton);

    tbody.addEventListener('click', function(e) {
        var toggle = e.target.closest('.expand-toggle');
        if (toggle) {
            var figureRow = toggle.closest('.figure-row');
            if (figureRow && parseInt(figureRow.dataset.linkCount) > 0) {
                toggleAffiliations(figureRow);
            }
        }

        // Handle "Show N more" links
        var showMoreLink = e.target.closest('.show-more-link');
        if (showMoreLink) {
            e.preventDefault();
            e.stopPropagation();
            var groupId = showMoreLink.dataset.group;
            var isCollapsed = showMoreLink.dataset.showing === 'collapsed';
            var hiddenItems = document.querySelectorAll('.' + groupId);

            hiddenItems.forEach(function(item) {
                if (isCollapsed) {
                    item.classList.remove('hidden-item');
                } else {
                    item.classList.add('hidden-item');
                }
            });

            if (isCollapsed) {
                showMoreLink.textContent = 'Show less';
                showMoreLink.dataset.showing = 'expanded';
            } else {
                showMoreLink.textContent = 'Show ' + hiddenItems.length + ' more';
                showMoreLink.dataset.showing = 'collapsed';
            }
        }
    });
})();
</script>
{% endblock %}
